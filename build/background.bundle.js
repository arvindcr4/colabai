(()=>{"use strict";class e{static simplifyCode(e){if(!e)return"";return this.applySimplificationRules(e).trim()}static applySimplificationRules(e){const t=this.removeParenthesesContent(e),n=this.simplifyFunctionImplementations(t),s=this.removeComments(n);return this.additionalSimplifications(s)}static removeParenthesesContent(e){return e.replace(/\((?:[^)(]*|\((?:[^)(]*|\([^)(]*\))*\))*\)/g,"(...)")}static simplifyFunctionImplementations(e){return e.replace(/((def|class)\s+\w+\s*\([^)]*\))\s*:[\s\S]*?(?=\n\S|\Z)/gm,(e,t)=>{const n=t.split(":")[0]+":";return t.startsWith("class"),n+"\n    ..."})}static removeComments(e){return e.replace(/#.*$/gm,"").replace(/"""[\s\S]*?"""/g,"").replace(/'''[\s\S]*?'''/g,"")}static additionalSimplifications(e){return e.replace(/^\s+$/gm,"").replace(/\n{3,}/g,"\n\n").split("\n").map(e=>e.trim()).filter(e=>e.length>0).join("\n")}}class t{constructor(){this.lastState=new Map,this.cellOrder=[]}updateState(e){const t=new Map,n=[],s=[];return e.forEach((e,s)=>{t.set(e.id,{id:e.id,type:e.type,content:e.content,index:s}),n.push(e.id)}),this.cellOrder=n,s.push(...this.detectAddedCells(t)),s.push(...this.detectRemovedCells(t)),s.push(...this.detectModifiedCells(t)),s.push(...this.detectMovedCells(n,t)),this.lastState=t,this.cellOrder=n,this.formatChangesForAI(s)}detectAddedCells(e){const t=[];return e.forEach((e,n)=>{this.lastState.has(n)||t.push({type:"add",cell:e,position:this.determineRelativePosition(e.index)})}),t}detectRemovedCells(e){const t=[];return this.lastState.forEach((n,s)=>{e.has(s)||t.push({type:"remove",cellId:s})}),t}detectModifiedCells(e){const t=[];return e.forEach((e,n)=>{const s=this.lastState.get(n);s&&s.content!==e.content&&t.push({type:"modify",cellId:n,oldContent:s.content,newContent:e.content})}),t}detectMovedCells(e,t){const n=[],s=new Map;return this.cellOrder.forEach((e,t)=>{s.set(e,t)}),e.forEach((e,t)=>{const r=s.get(e);void 0!==r&&r!==t&&n.push({type:"move",cellId:e,position:this.determineRelativePosition(t)})}),n}determineRelativePosition(e){if(0===e)return"top";if(e===this.cellOrder.length)return"bottom";return`after:${this.cellOrder[e-1]}`}formatChangesForAI(e){let t="@CHANGELOG\n";return e.forEach(e=>{switch(e.type){case"add":const n=e;t+=`@ADDED[id=${n.cell.id}, type=${n.cell.type}, position=${n.position}]\n`,t+=n.cell.content+"\n",t+="@END\n\n";break;case"remove":t+=`@REMOVED[${e.cellId}]\n\n`;break;case"modify":const s=e;t+=`@MODIFIED[${s.cellId}]\n`,t+="--- Previous content ---\n",t+=s.oldContent+"\n",t+="--- New content ---\n",t+=s.newContent+"\n",t+="@END\n\n";break;case"move":const r=e;t+=`@MOVED[${r.cellId}, position=${r.position}]\n\n`}}),t+="@END_CHANGELOG",t}getLastState(t=[],n=!0){const s=Array.from(this.lastState.values()).map(s=>{const r=t.includes(s.id)?s.content:n&&"code"===s.type?e.simplifyCode(s.content):s.content;return{id:s.id,type:s.type,content:r}});return JSON.stringify(s)}}var n;!function(e){e.UNKNOWN="unknown",e.NETWORK="network",e.SERVER="server",e.AUTHENTICATION="authentication",e.INVALID_REQUEST="invalid_request",e.QUOTA_EXCEEDED="quota_exceeded",e.MODEL_ACCESS="model_access",e.CONFIGURATION="configuration",e.GENERATION_IN_PROGRESS="generation_in_progress",e.RATE_LIMIT="rate_limit"}(n||(n={}));class s extends Error{constructor(e){super(e.message),this.type=e.type,this.details=e.details,this.name="AIServiceError"}}let r=null,o=!1;const i=()=>{r=null,o=!1};var a=function(e,t,n,s){return new(n||(n=Promise))(function(r,o){function i(e){try{l(s.next(e))}catch(e){o(e)}}function a(e){try{l(s.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(i,a)}l((s=s.apply(e,t||[])).next())})};const l=e=>a(void 0,void 0,void 0,function*(){let t=r;if(!t)try{const e=yield chrome.tabs.query({active:!0,currentWindow:!0});e.length>0&&e[0].id&&(t=e[0].id,(e=>{if(o)throw new Error("Another tab is currently generating content");r=e,o=!0})(t))}catch(e){if(e instanceof Error&&"Another tab is currently generating content"===e.message)return void c({type:n.GENERATION_IN_PROGRESS,message:"Please wait for the current generation to complete before starting a new one."});throw e}if(t)try{return yield chrome.tabs.sendMessage(t,e)}catch(e){console.error("Error sending message to tab:",e)}}),c=e=>{l({action:"ai_error",error:e})};function u(e){var t;return a(this,void 0,void 0,function*(){const n=yield l({action:"ai_operation",operation:e});return null===(t=null==n?void 0:n.data)||void 0===t?void 0:t.id})}var d=function(e,t,n,s){return new(n||(n=Promise))(function(r,o){function i(e){try{l(s.next(e))}catch(e){o(e)}}function a(e){try{l(s.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(i,a)}l((s=s.apply(e,t||[])).next())})};var h=function(e,t,n,s){return new(n||(n=Promise))(function(r,o){function i(e){try{l(s.next(e))}catch(e){o(e)}}function a(e){try{l(s.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(i,a)}l((s=s.apply(e,t||[])).next())})};const p={buffer:"",textContent:"",fullResponse:"",appliedOperations:new Map,currentOperations:new Map,isCodeBlock:!1,originalContent:[]};function f(e,t){return h(this,void 0,void 0,function*(){p.buffer=p.buffer+e,p.fullResponse=p.fullResponse+e;const n=p.buffer.split(/\r?\n/);if(p.buffer=n.pop()||"",!p.isCodeBlock){const t=p.textContent+e;p.textContent=t,l({action:"ai_text_content",content:t})}var s;return yield function(e,t){var n,s,r;return d(this,void 0,void 0,function*(){const o=/@CREATE\[type=(markdown|code),\s*position=(top|bottom|after:(cell-[^\]]+)|before:(cell-[^\]]+))\]/,i=/@EDIT\[(cell-[^\]]+)\]/,a=/@DELETE\[(cell-[^\]]+)\]/,l=/@END/,c=/@START_CODE/,d=/@END_CODE/;for(const h of t){if(h.match(c))return e.isCodeBlock=!0,e;if(h.match(d))return e.isCodeBlock=!1,e;const t=h.match(o),p=h.match(i),f=h.match(a);if(t){Date.now(),Math.random();const n={type:"create",cellType:t[1],cellId:"",position:t[2],contentArray:[],content:""};let s;if(n.position.startsWith("after:")){let t=n.position;const r=Array.from(e.appliedOperations.values()).filter(e=>"create"===e.type&&e.position===n.position);r.length>0&&(t=`after:${r[r.length-1].cellId}`),s=yield u(Object.assign(Object.assign({},n),{position:t}))}else s=yield u(n);if(!s||""===s)return console.log("[Parser] Failed to apply operation:",n),e;n.cellId=s,e.currentOperations.set(n.cellId,n),console.log("[Parser] Create operation:",n)}else if(p){const t=p[1],s={type:"edit",cellId:t,contentArray:[],content:"",originalContent:(null===(n=e.originalContent.find(e=>e.id===t))||void 0===n?void 0:n.content)||""};e.currentOperations.set(t,s),yield u(s),console.log("[Parser] Edit operation:",s)}else if(f){const t=f[1],n=(null===(s=e.originalContent.find(e=>e.id===t))||void 0===s?void 0:s.content)||"",r={type:"delete",cellId:t,originalContent:n};yield u(r),e.appliedOperations.set(t,Object.assign(Object.assign({},r),{pending:!0})),console.log("[Parser] Delete operation:",t)}else if(h.match(l)){for(const[t,n]of e.currentOperations.entries())if("create"===n.type||"edit"===n.type){console.log("[Parser] Applied operation:",n);const t=Object.assign(Object.assign({},n),{pending:!0});e.appliedOperations.set(n.cellId,t),yield u({type:"diff",cellId:n.cellId,originalContent:"edit"===n.type?n.originalContent:"",content:n.content})}e.currentOperations.clear()}else for(const t of e.currentOperations.values())"delete"!==t.type&&"contentArray"in t&&t.contentArray&&(null===(r=t.contentArray)||void 0===r||r.push(h),t.content=t.contentArray.join("\n"),yield u({type:"edit",cellId:t.cellId,contentArray:t.contentArray,content:t.content,originalContent:"edit"===t.type?t.originalContent:""}))}return e})}(p,n),t&&(s=p.appliedOperations,l({action:"ai_done_generating",pendingOperations:[...s.entries()]})),p})}var m=function(e,t,n,s){return new(n||(n=Promise))(function(r,o){function i(e){try{l(s.next(e))}catch(e){o(e)}}function a(e){try{l(s.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(i,a)}l((s=s.apply(e,t||[])).next())})},y=function(e){return this instanceof y?(this.v=e,this):new y(e)},g=function(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var s,r=n.apply(e,t||[]),o=[];return s={},i("next"),i("throw"),i("return"),s[Symbol.asyncIterator]=function(){return this},s;function i(e){r[e]&&(s[e]=function(t){return new Promise(function(n,s){o.push([e,t,n,s])>1||a(e,t)})})}function a(e,t){try{(n=r[e](t)).value instanceof y?Promise.resolve(n.value.v).then(l,c):u(o[0][2],n)}catch(e){u(o[0][3],e)}var n}function l(e){a("next",e)}function c(e){a("throw",e)}function u(e,t){e(t),o.shift(),o.length&&a(o[0][0],o[0][1])}};class w{constructor(e){this.baseUrl="https://api.mistral.ai/v1",this.config=e}generate(e){var t,r;return m(this,void 0,void 0,function*(){try{const n=e.map(e=>({role:e.role,content:e.content})),s=yield fetch(`${this.baseUrl}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify({model:this.config.model,messages:n,temperature:this.config.temperature||.7})});s.ok||(yield this.handleResponseError(s));const o=yield s.json();return(null===(r=null===(t=o.choices[0])||void 0===t?void 0:t.message)||void 0===r?void 0:r.content)||""}catch(e){if(console.error("Mistral API error:",e),e instanceof s)throw e;throw new s({type:n.SERVER,message:`Error calling Mistral API: ${e.message||"Unknown error"}`,details:e})}})}generateStream(e){var t,r,o;return g(this,arguments,function*(){try{const i=e.map(e=>({role:e.role,content:e.content})),a=yield y(fetch(`${this.baseUrl}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify({model:this.config.model,messages:i,temperature:this.config.temperature||.7,stream:!0})}));if(a.ok||(yield y(this.handleResponseError(a))),!a.body)throw new s({type:n.SERVER,message:"Mistral API returned empty response stream"});const l=a.body.getReader(),c=new TextDecoder("utf-8");let u="";for(;;){const{done:e,value:n}=yield y(l.read());if(e)break;u+=c.decode(n,{stream:!0});const s=u.split("\n");u=s.pop()||"";for(const e of s)if(e.startsWith("data: ")){const n=e.slice(6);if("[DONE]"===n)return yield yield y({content:"",isComplete:!0}),yield y(void 0);try{const e=JSON.parse(n),s=(null===(r=null===(t=e.choices[0])||void 0===t?void 0:t.delta)||void 0===r?void 0:r.content)||"",i="stop"===(null===(o=e.choices[0])||void 0===o?void 0:o.finish_reason);if(yield yield y({content:s,isComplete:i}),i)return yield y(void 0)}catch(e){console.error("Error parsing SSE data:",e)}}}}catch(e){if(console.error("Mistral streaming error:",e),e instanceof s)throw e;throw new s({type:n.SERVER,message:`Error streaming from Mistral API: ${e.message||"Unknown error"}`,details:e})}})}handleResponseError(e){var t;return m(this,void 0,void 0,function*(){const r=yield e.json().catch(()=>({}));throw 401===e.status?new s({type:n.AUTHENTICATION,message:"Invalid Mistral API key. Please check your API key in the extension options."}):429===e.status?new s({type:n.QUOTA_EXCEEDED,message:"Mistral API rate limit exceeded. Please try again later."}):404===e.status?new s({type:n.MODEL_ACCESS,message:`The requested model "${this.config.model}" is not available with your API key.`}):new s({type:n.SERVER,message:`Mistral API error (${e.status}): ${(null===(t=r.error)||void 0===t?void 0:t.message)||"Unknown error"}`,details:r})})}}const v="RFC3986",_={RFC1738:e=>String(e).replace(/%20/g,"+"),RFC3986:e=>String(e)},b=(Object.prototype.hasOwnProperty,Array.isArray),E=(()=>{const e=[];for(let t=0;t<256;++t)e.push("%"+((t<16?"0":"")+t.toString(16)).toUpperCase());return e})();const x=1024;function A(e,t){if(b(e)){const n=[];for(let s=0;s<e.length;s+=1)n.push(t(e[s]));return n}return t(e)}const I=Object.prototype.hasOwnProperty,S={brackets:e=>String(e)+"[]",comma:"comma",indices:(e,t)=>String(e)+"["+t+"]",repeat:e=>String(e)},P=Array.isArray,R=Array.prototype.push,O=function(e,t){R.apply(e,P(t)?t:[t])},C=Date.prototype.toISOString,k={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:(e,t,n,s,r)=>{if(0===e.length)return e;let o=e;if("symbol"==typeof e?o=Symbol.prototype.toString.call(e):"string"!=typeof e&&(o=String(e)),"iso-8859-1"===n)return escape(o).replace(/%u[0-9a-f]{4}/gi,function(e){return"%26%23"+parseInt(e.slice(2),16)+"%3B"});let i="";for(let e=0;e<o.length;e+=x){const t=o.length>=x?o.slice(e,e+x):o,n=[];for(let e=0;e<t.length;++e){let s=t.charCodeAt(e);45===s||46===s||95===s||126===s||s>=48&&s<=57||s>=65&&s<=90||s>=97&&s<=122||"RFC1738"===r&&(40===s||41===s)?n[n.length]=t.charAt(e):s<128?n[n.length]=E[s]:s<2048?n[n.length]=E[192|s>>6]+E[128|63&s]:s<55296||s>=57344?n[n.length]=E[224|s>>12]+E[128|s>>6&63]+E[128|63&s]:(e+=1,s=65536+((1023&s)<<10|1023&t.charCodeAt(e)),n[n.length]=E[240|s>>18]+E[128|s>>12&63]+E[128|s>>6&63]+E[128|63&s])}i+=n.join("")}return i},encodeValuesOnly:!1,format:v,formatter:_[v],indices:!1,serializeDate:e=>C.call(e),skipNulls:!1,strictNullHandling:!1};const T={};function $(e,t,n,s,r,o,i,a,l,c,u,d,h,p,f,m,y,g){let w=e,v=g,_=0,b=!1;for(;void 0!==(v=v.get(T))&&!b;){const t=v.get(e);if(_+=1,void 0!==t){if(t===_)throw new RangeError("Cyclic object value");b=!0}void 0===v.get(T)&&(_=0)}if("function"==typeof c?w=c(t,w):w instanceof Date?w=h?.(w):"comma"===n&&P(w)&&(w=A(w,function(e){return e instanceof Date?h?.(e):e})),null===w){if(o)return l&&!m?l(t,k.encoder,y,"key",p):t;w=""}if("string"==typeof(E=w)||"number"==typeof E||"boolean"==typeof E||"symbol"==typeof E||"bigint"==typeof E||function(e){return!(!e||"object"!=typeof e||!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e)))}(w)){if(l){const e=m?t:l(t,k.encoder,y,"key",p);return[f?.(e)+"="+f?.(l(w,k.encoder,y,"value",p))]}return[f?.(t)+"="+f?.(String(w))]}var E;const x=[];if(void 0===w)return x;let I;if("comma"===n&&P(w))m&&l&&(w=A(w,l)),I=[{value:w.length>0?w.join(",")||null:void 0}];else if(P(c))I=c;else{const e=Object.keys(w);I=u?e.sort(u):e}const S=a?String(t).replace(/\./g,"%2E"):String(t),R=s&&P(w)&&1===w.length?S+"[]":S;if(r&&P(w)&&0===w.length)return R+"[]";for(let t=0;t<I.length;++t){const v=I[t],b="object"==typeof v&&void 0!==v.value?v.value:w[v];if(i&&null===b)continue;const E=d&&a?v.replace(/\./g,"%2E"):v,A=P(w)?"function"==typeof n?n(R,E):R:R+(d?"."+E:"["+E+"]");g.set(e,_);const S=new WeakMap;S.set(T,g),O(x,$(b,A,n,s,r,o,i,a,"comma"===n&&m&&P(w)?null:l,c,u,d,h,p,f,m,y,S))}return x}function N(e,t={}){let n=e;const s=function(e=k){if(void 0!==e.allowEmptyArrays&&"boolean"!=typeof e.allowEmptyArrays)throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(void 0!==e.encodeDotInKeys&&"boolean"!=typeof e.encodeDotInKeys)throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(null!==e.encoder&&void 0!==e.encoder&&"function"!=typeof e.encoder)throw new TypeError("Encoder has to be a function.");const t=e.charset||k.charset;if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let n=v;if(void 0!==e.format){if(!I.call(_,e.format))throw new TypeError("Unknown format option provided.");n=e.format}const s=_[n];let r,o=k.filter;if(("function"==typeof e.filter||P(e.filter))&&(o=e.filter),r=e.arrayFormat&&e.arrayFormat in S?e.arrayFormat:"indices"in e?e.indices?"indices":"repeat":k.arrayFormat,"commaRoundTrip"in e&&"boolean"!=typeof e.commaRoundTrip)throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const i=void 0===e.allowDots?1==!!e.encodeDotInKeys||k.allowDots:!!e.allowDots;return{addQueryPrefix:"boolean"==typeof e.addQueryPrefix?e.addQueryPrefix:k.addQueryPrefix,allowDots:i,allowEmptyArrays:"boolean"==typeof e.allowEmptyArrays?!!e.allowEmptyArrays:k.allowEmptyArrays,arrayFormat:r,charset:t,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:k.charsetSentinel,commaRoundTrip:!!e.commaRoundTrip,delimiter:void 0===e.delimiter?k.delimiter:e.delimiter,encode:"boolean"==typeof e.encode?e.encode:k.encode,encodeDotInKeys:"boolean"==typeof e.encodeDotInKeys?e.encodeDotInKeys:k.encodeDotInKeys,encoder:"function"==typeof e.encoder?e.encoder:k.encoder,encodeValuesOnly:"boolean"==typeof e.encodeValuesOnly?e.encodeValuesOnly:k.encodeValuesOnly,filter:o,format:n,formatter:s,serializeDate:"function"==typeof e.serializeDate?e.serializeDate:k.serializeDate,skipNulls:"boolean"==typeof e.skipNulls?e.skipNulls:k.skipNulls,sort:"function"==typeof e.sort?e.sort:null,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:k.strictNullHandling}}(t);let r,o;"function"==typeof s.filter?(o=s.filter,n=o("",n)):P(s.filter)&&(o=s.filter,r=o);const i=[];if("object"!=typeof n||null===n)return"";const a=S[s.arrayFormat],l="comma"===a&&s.commaRoundTrip;r||(r=Object.keys(n)),s.sort&&r.sort(s.sort);const c=new WeakMap;for(let e=0;e<r.length;++e){const t=r[e];s.skipNulls&&null===n[t]||O(i,$(n[t],t,a,l,s.allowEmptyArrays,s.strictNullHandling,s.skipNulls,s.encodeDotInKeys,s.encode?s.encoder:null,s.filter,s.sort,s.allowDots,s.serializeDate,s.format,s.formatter,s.encodeValuesOnly,s.charset,c))}const u=i.join(s.delimiter);let d=!0===s.addQueryPrefix?"?":"";return s.charsetSentinel&&("iso-8859-1"===s.charset?d+="utf8=%26%2310003%3B&":d+="utf8=%E2%9C%93&"),u.length>0?d+u:""}const D="4.104.0";let M,j,U,L,q,B,F,W,J,X=!1,V=null,G=null,H=null,K=null;class z{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}}const Q=()=>{M||function(e,t={auto:!1}){if(X)throw new Error(`you must \`import 'openai/shims/${e.kind}'\` before importing anything else from openai`);if(M)throw new Error(`can't \`import 'openai/shims/${e.kind}'\` after \`import 'openai/shims/${M}'\``);X=t.auto,M=e.kind,j=e.fetch,V=e.Request,G=e.Response,H=e.Headers,U=e.FormData,K=e.Blob,L=e.File,q=e.ReadableStream,B=e.getMultipartRequestOptions,F=e.getDefaultAgent,W=e.fileFromPath,J=e.isFsReadStream}(function({manuallyImported:e}={}){const t=e?"You may need to use polyfills":"Add one of these imports before your first `import â€¦ from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n";let n,s,r,o;try{n=fetch,s=Request,r=Response,o=Headers}catch(e){throw new Error(`this environment is missing the following Web Fetch API type: ${e.message}. ${t}`)}return{kind:"web",fetch:n,Request:s,Response:r,Headers:o,FormData:"undefined"!=typeof FormData?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${t}`)}},Blob:"undefined"!=typeof Blob?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${t}`)}},File:"undefined"!=typeof File?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${t}`)}},ReadableStream:"undefined"!=typeof ReadableStream?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${t}`)}},getMultipartRequestOptions:async(e,t)=>({...t,body:new z(e)}),getDefaultAgent:e=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:e=>!1}}(),{auto:!0})};Q();class Y extends Error{}class Z extends Y{constructor(e,t,n,s){super(`${Z.makeMessage(e,t,n)}`),this.status=e,this.headers=s,this.request_id=s?.["x-request-id"],this.error=t;const r=t;this.code=r?.code,this.param=r?.param,this.type=r?.type}static makeMessage(e,t,n){const s=t?.message?"string"==typeof t.message?t.message:JSON.stringify(t.message):t?JSON.stringify(t):n;return e&&s?`${e} ${s}`:e?`${e} status code (no body)`:s||"(no status code or body)"}static generate(e,t,n,s){if(!e||!s)return new te({message:n,cause:tt(t)});const r=t?.error;return 400===e?new se(e,r,n,s):401===e?new re(e,r,n,s):403===e?new oe(e,r,n,s):404===e?new ie(e,r,n,s):409===e?new ae(e,r,n,s):422===e?new le(e,r,n,s):429===e?new ce(e,r,n,s):e>=500?new ue(e,r,n,s):new Z(e,r,n,s)}}class ee extends Z{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class te extends Z{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}}class ne extends te{constructor({message:e}={}){super({message:e??"Request timed out."})}}class se extends Z{}class re extends Z{}class oe extends Z{}class ie extends Z{}class ae extends Z{}class le extends Z{}class ce extends Z{}class ue extends Z{}class de extends Y{constructor(){super("Could not parse response content as the length limit was reached")}}class he extends Y{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}var pe,fe=function(e,t,n,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(e,n):r?r.value=n:t.set(e,n),n},me=function(e,t,n,s){if("a"===n&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?s:"a"===n?s.call(e):s?s.value:t.get(e)};class ye{constructor(){pe.set(this,void 0),this.buffer=new Uint8Array,fe(this,pe,null,"f")}decode(e){if(null==e)return[];const t=e instanceof ArrayBuffer?new Uint8Array(e):"string"==typeof e?(new TextEncoder).encode(e):e;let n=new Uint8Array(this.buffer.length+t.length);n.set(this.buffer),n.set(t,this.buffer.length),this.buffer=n;const s=[];let r;for(;null!=(r=ge(this.buffer,me(this,pe,"f")));){if(r.carriage&&null==me(this,pe,"f")){fe(this,pe,r.index,"f");continue}if(null!=me(this,pe,"f")&&(r.index!==me(this,pe,"f")+1||r.carriage)){s.push(this.decodeText(this.buffer.slice(0,me(this,pe,"f")-1))),this.buffer=this.buffer.slice(me(this,pe,"f")),fe(this,pe,null,"f");continue}const e=null!==me(this,pe,"f")?r.preceding-1:r.preceding,t=this.decodeText(this.buffer.slice(0,e));s.push(t),this.buffer=this.buffer.slice(r.index),fe(this,pe,null,"f")}return s}decodeText(e){if(null==e)return"";if("string"==typeof e)return e;if("undefined"!=typeof Buffer){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new Y(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if("undefined"!=typeof TextDecoder){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new Y(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new Y("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){return this.buffer.length?this.decode("\n"):[]}}function ge(e,t){for(let n=t??0;n<e.length;n++){if(10===e[n])return{preceding:n,index:n+1,carriage:!1};if(13===e[n])return{preceding:n,index:n+1,carriage:!0}}return null}function we(e){for(let t=0;t<e.length-1;t++){if(10===e[t]&&10===e[t+1])return t+2;if(13===e[t]&&13===e[t+1])return t+2;if(13===e[t]&&10===e[t+1]&&t+3<e.length&&13===e[t+2]&&10===e[t+3])return t+4}return-1}function ve(e){if(e[Symbol.asyncIterator])return e;const t=e.getReader();return{async next(){try{const e=await t.read();return e?.done&&t.releaseLock(),e}catch(e){throw t.releaseLock(),e}},async return(){const e=t.cancel();return t.releaseLock(),await e,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}pe=new WeakMap,ye.NEWLINE_CHARS=new Set(["\n","\r"]),ye.NEWLINE_REGEXP=/\r\n|[\n\r]/g;class _e{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let n=!1;return new _e(async function*(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let s=!1;try{for await(const n of async function*(e,t){if(!e.body)throw t.abort(),new Y("Attempted to iterate over a response with no body");const n=new be,s=new ye,r=ve(e.body);for await(const e of async function*(e){let t=new Uint8Array;for await(const n of e){if(null==n)continue;const e=n instanceof ArrayBuffer?new Uint8Array(n):"string"==typeof n?(new TextEncoder).encode(n):n;let s,r=new Uint8Array(t.length+e.length);for(r.set(t),r.set(e,t.length),t=r;-1!==(s=we(t));)yield t.slice(0,s),t=t.slice(s)}t.length>0&&(yield t)}(r))for(const t of s.decode(e)){const e=n.decode(t);e&&(yield e)}for(const e of s.flush()){const t=n.decode(e);t&&(yield t)}}(e,t))if(!s)if(n.data.startsWith("[DONE]"))s=!0;else if(null===n.event||n.event.startsWith("response.")||n.event.startsWith("transcript.")){let t;try{t=JSON.parse(n.data)}catch(e){throw console.error("Could not parse message into JSON:",n.data),console.error("From chunk:",n.raw),e}if(t&&t.error)throw new Z(void 0,t.error,void 0,Fe(e.headers));yield t}else{let e;try{e=JSON.parse(n.data)}catch(e){throw console.error("Could not parse message into JSON:",n.data),console.error("From chunk:",n.raw),e}if("error"==n.event)throw new Z(void 0,e.error,e.message,void 0);yield{event:n.event,data:e}}s=!0}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;throw e}finally{s||t.abort()}},t)}static fromReadableStream(e,t){let n=!1;return new _e(async function*(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let s=!1;try{for await(const t of async function*(){const t=new ye,n=ve(e);for await(const e of n)for(const n of t.decode(e))yield n;for(const e of t.flush())yield e}())s||t&&(yield JSON.parse(t));s=!0}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;throw e}finally{s||t.abort()}},t)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],t=[],n=this.iterator(),s=s=>({next:()=>{if(0===s.length){const s=n.next();e.push(s),t.push(s)}return s.shift()}});return[new _e(()=>s(e),this.controller),new _e(()=>s(t),this.controller)]}toReadableStream(){const e=this;let t;const n=new TextEncoder;return new q({async start(){t=e[Symbol.asyncIterator]()},async pull(e){try{const{value:s,done:r}=await t.next();if(r)return e.close();const o=n.encode(JSON.stringify(s)+"\n");e.enqueue(o)}catch(t){e.error(t)}},async cancel(){await(t.return?.())}})}}class be{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const e={event:this.event,data:this.data.join("\n"),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],e}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,n,s]=function(e,t){const n=e.indexOf(t);if(-1!==n)return[e.substring(0,n),t,e.substring(n+t.length)];return[e,"",""]}(e,":");return s.startsWith(" ")&&(s=s.substring(1)),"event"===t?this.event=s:"data"===t&&this.data.push(s),null}}const Ee=e=>null!=e&&"object"==typeof e&&"string"==typeof e.url&&"function"==typeof e.blob,xe=e=>null!=e&&"object"==typeof e&&"string"==typeof e.name&&"number"==typeof e.lastModified&&Ae(e),Ae=e=>null!=e&&"object"==typeof e&&"number"==typeof e.size&&"string"==typeof e.type&&"function"==typeof e.text&&"function"==typeof e.slice&&"function"==typeof e.arrayBuffer,Ie=e=>xe(e)||Ee(e)||J(e);async function Se(e,t,n){if(e=await e,xe(e))return e;if(Ee(e)){const s=await e.blob();t||(t=new URL(e.url).pathname.split(/[\\/]/).pop()??"unknown_file");const r=Ae(s)?[await s.arrayBuffer()]:[s];return new L(r,t,n)}const s=await async function(e){let t=[];if("string"==typeof e||ArrayBuffer.isView(e)||e instanceof ArrayBuffer)t.push(e);else if(Ae(e))t.push(await e.arrayBuffer());else{if(!Re(e))throw new Error(`Unexpected data type: ${typeof e}; constructor: ${e?.constructor?.name}; props: ${function(e){const t=Object.getOwnPropertyNames(e);return`[${t.map(e=>`"${e}"`).join(", ")}]`}(e)}`);for await(const n of e)t.push(n)}return t}(e);if(t||(t=function(e){return Pe(e.name)||Pe(e.filename)||Pe(e.path)?.split(/[\\/]/).pop()}(e)??"unknown_file"),!n?.type){const e=s[0]?.type;"string"==typeof e&&(n={...n,type:e})}return new L(s,t,n)}const Pe=e=>"string"==typeof e?e:"undefined"!=typeof Buffer&&e instanceof Buffer?String(e):void 0,Re=e=>null!=e&&"object"==typeof e&&"function"==typeof e[Symbol.asyncIterator],Oe=e=>e&&"object"==typeof e&&e.body&&"MultipartBody"===e[Symbol.toStringTag],Ce=async e=>{const t=await ke(e.body);return B(t,e)},ke=async e=>{const t=new U;return await Promise.all(Object.entries(e||{}).map(([e,n])=>Te(t,e,n))),t},Te=async(e,t,n)=>{if(void 0!==n){if(null==n)throw new TypeError(`Received null for "${t}"; to pass null in FormData, you must use the string 'null'`);if("string"==typeof n||"number"==typeof n||"boolean"==typeof n)e.append(t,String(n));else if(Ie(n)){const s=await Se(n);e.append(t,s)}else if(Array.isArray(n))await Promise.all(n.map(n=>Te(e,t+"[]",n)));else{if("object"!=typeof n)throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${n} instead`);await Promise.all(Object.entries(n).map(([n,s])=>Te(e,`${t}[${n}]`,s)))}}};var $e,Ne=function(e,t,n,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(e,n):r?r.value=n:t.set(e,n),n},De=function(e,t,n,s){if("a"===n&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?s:"a"===n?s.call(e):s?s.value:t.get(e)};async function Me(e){const{response:t}=e;if(e.options.stream)return at("response",t.status,t.url,t.headers,t.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(t,e.controller):_e.fromSSEResponse(t,e.controller);if(204===t.status)return null;if(e.options.__binaryResponse)return t;const n=t.headers.get("content-type"),s=n?.split(";")[0]?.trim();if(s?.includes("application/json")||s?.endsWith("+json")){const e=await t.json();return at("response",t.status,t.url,t.headers,e),je(e,t)}const r=await t.text();return at("response",t.status,t.url,t.headers,r),r}function je(e,t){return!e||"object"!=typeof e||Array.isArray(e)?e:Object.defineProperty(e,"_request_id",{value:t.headers.get("x-request-id"),enumerable:!1})}Q();class Ue extends Promise{constructor(e,t=Me){super(e=>{e(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new Ue(this.responsePromise,async t=>je(e(await this.parseResponse(t),t),t.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}class Le{constructor({baseURL:e,maxRetries:t=2,timeout:n=6e5,httpAgent:s,fetch:r}){this.baseURL=e,this.maxRetries=et("maxRetries",t),this.timeout=et("timeout",n),this.httpAgent=s,this.fetch=r??j}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...Ke(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${lt()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,n){return this.request(Promise.resolve(n).then(async n=>{const s=n&&Ae(n?.body)?new DataView(await n.body.arrayBuffer()):n?.body instanceof DataView?n.body:n?.body instanceof ArrayBuffer?new DataView(n.body):n&&ArrayBuffer.isView(n?.body)?new DataView(n.body.buffer):n?.body;return{method:e,path:t,...n,body:s}}))}getAPIList(e,t,n){return this.requestAPIList(t,{method:"get",path:e,...n})}calculateContentLength(e){if("string"==typeof e){if("undefined"!=typeof Buffer)return Buffer.byteLength(e,"utf8").toString();if("undefined"!=typeof TextEncoder){return(new TextEncoder).encode(e).length.toString()}}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){const n={...e},{method:s,path:r,query:o,headers:i={}}=n,a=ArrayBuffer.isView(n.body)||n.__binaryRequest&&"string"==typeof n.body?n.body:Oe(n.body)?n.body.body:n.body?JSON.stringify(n.body,null,2):null,l=this.calculateContentLength(a),c=this.buildURL(r,o);"timeout"in n&&et("timeout",n.timeout),n.timeout=n.timeout??this.timeout;const u=n.httpAgent??this.httpAgent??F(c),d=n.timeout+1e3;"number"==typeof u?.options?.timeout&&d>(u.options.timeout??0)&&(u.options.timeout=d),this.idempotencyHeader&&"get"!==s&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),i[this.idempotencyHeader]=e.idempotencyKey);return{req:{method:s,...a&&{body:a},headers:this.buildHeaders({options:n,headers:i,contentLength:l,retryCount:t}),...u&&{agent:u},signal:n.signal??null},url:c,timeout:n.timeout}}buildHeaders({options:e,headers:t,contentLength:n,retryCount:s}){const r={};n&&(r["content-length"]=n);const o=this.defaultHeaders(e);return ot(r,o),ot(r,t),Oe(e.body)&&"node"!==M&&delete r["content-type"],void 0===ct(o,"x-stainless-retry-count")&&void 0===ct(t,"x-stainless-retry-count")&&(r["x-stainless-retry-count"]=String(s)),void 0===ct(o,"x-stainless-timeout")&&void 0===ct(t,"x-stainless-timeout")&&e.timeout&&(r["x-stainless-timeout"]=String(Math.trunc(e.timeout/1e3))),this.validateHeaders(r,t),r}async prepareOptions(e){}async prepareRequest(e,{url:t,options:n}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(e=>[...e])):{...e}:{}}makeStatusError(e,t,n,s){return Z.generate(e,t,n,s)}request(e,t=null){return new Ue(this.makeRequest(e,t))}async makeRequest(e,t){const n=await e,s=n.maxRetries??this.maxRetries;null==t&&(t=s),await this.prepareOptions(n);const{req:r,url:o,timeout:i}=this.buildRequest(n,{retryCount:s-t});if(await this.prepareRequest(r,{url:o,options:n}),at("request",o,n,r.headers),n.signal?.aborted)throw new ee;const a=new AbortController,l=await this.fetchWithTimeout(o,r,i,a).catch(tt);if(l instanceof Error){if(n.signal?.aborted)throw new ee;if(t)return this.retryRequest(n,t);if("AbortError"===l.name)throw new ne;throw new te({cause:l})}const c=Fe(l.headers);if(!l.ok){if(t&&this.shouldRetry(l)){return at(`response (error; ${`retrying, ${t} attempts remaining`})`,l.status,o,c),this.retryRequest(n,t,c)}const e=await l.text().catch(e=>tt(e).message),s=ze(e),r=s?void 0:e;at(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,l.status,o,c,r);throw this.makeStatusError(l.status,s,r,c)}return{response:l,options:n,controller:a}}requestAPIList(e,t){const n=this.makeRequest(t,null);return new Be(this,n,e)}buildURL(e,t){const n=Ye(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),s=this.defaultQuery();return st(s)||(t={...s,...t}),"object"==typeof t&&t&&!Array.isArray(t)&&(n.search=this.stringifyQuery(t)),n.toString()}stringifyQuery(e){return Object.entries(e).filter(([e,t])=>void 0!==t).map(([e,t])=>{if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return`${encodeURIComponent(e)}=${encodeURIComponent(t)}`;if(null===t)return`${encodeURIComponent(e)}=`;throw new Y(`Cannot stringify type ${typeof t}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,n,s){const{signal:r,...o}=t||{};r&&r.addEventListener("abort",()=>s.abort());const i=setTimeout(()=>s.abort(),n),a={signal:s.signal,...o};return a.method&&(a.method=a.method.toUpperCase()),this.fetch.call(void 0,e,a).finally(()=>{clearTimeout(i)})}shouldRetry(e){const t=e.headers.get("x-should-retry");return"true"===t||"false"!==t&&(408===e.status||(409===e.status||(429===e.status||e.status>=500)))}async retryRequest(e,t,n){let s;const r=n?.["retry-after-ms"];if(r){const e=parseFloat(r);Number.isNaN(e)||(s=e)}const o=n?.["retry-after"];if(o&&!s){const e=parseFloat(o);s=Number.isNaN(e)?Date.parse(o)-Date.now():1e3*e}if(!(s&&0<=s&&s<6e4)){const n=e.maxRetries??this.maxRetries;s=this.calculateDefaultRetryTimeoutMillis(t,n)}return await Ze(s),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){const n=t-e;return Math.min(.5*Math.pow(2,n),8)*(1-.25*Math.random())*1e3}getUserAgent(){return`${this.constructor.name}/JS ${D}`}}class qe{constructor(e,t,n,s){$e.set(this,void 0),Ne(this,$e,e,"f"),this.options=s,this.response=t,this.body=n}hasNextPage(){return!!this.getPaginatedItems().length&&null!=this.nextPageInfo()}async getNextPage(){const e=this.nextPageInfo();if(!e)throw new Y("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const t={...this.options};if("params"in e&&"object"==typeof t.query)t.query={...t.query,...e.params};else if("url"in e){const n=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(const[t,s]of n)e.url.searchParams.set(t,s);t.query=void 0,t.path=e.url.toString()}return await De(this,$e,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[($e=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}class Be extends Ue{constructor(e,t,n){super(t,async t=>new n(e,t.response,await Me(t),t.options))}async*[Symbol.asyncIterator](){const e=await(this);for await(const t of e)yield t}}const Fe=e=>new Proxy(Object.fromEntries(e.entries()),{get(e,t){const n=t.toString();return e[n.toLowerCase()]||e[n]}}),We={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__metadata:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},Je=e=>"object"==typeof e&&null!==e&&!st(e)&&Object.keys(e).every(e=>rt(We,e)),Xe=()=>{if("undefined"!=typeof Deno&&null!=Deno.build)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":D,"X-Stainless-OS":Ge(Deno.build.os),"X-Stainless-Arch":Ve(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":"string"==typeof Deno.version?Deno.version:Deno.version?.deno??"unknown"};if("undefined"!=typeof EdgeRuntime)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":D,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if("[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0))return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":D,"X-Stainless-OS":Ge(process.platform),"X-Stainless-Arch":Ve(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const e=function(){if("undefined"==typeof navigator||!navigator)return null;const e=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:t,pattern:n}of e){const e=n.exec(navigator.userAgent);if(e){return{browser:t,version:`${e[1]||0}.${e[2]||0}.${e[3]||0}`}}}return null}();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":D,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":D,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};const Ve=e=>"x32"===e?"x32":"x86_64"===e||"x64"===e?"x64":"arm"===e?"arm":"aarch64"===e||"arm64"===e?"arm64":e?`other:${e}`:"unknown",Ge=e=>(e=e.toLowerCase()).includes("ios")?"iOS":"android"===e?"Android":"darwin"===e?"MacOS":"win32"===e?"Windows":"freebsd"===e?"FreeBSD":"openbsd"===e?"OpenBSD":"linux"===e?"Linux":e?`Other:${e}`:"Unknown";let He;const Ke=()=>He??(He=Xe()),ze=e=>{try{return JSON.parse(e)}catch(e){return}},Qe=/^[a-z][a-z0-9+.-]*:/i,Ye=e=>Qe.test(e),Ze=e=>new Promise(t=>setTimeout(t,e)),et=(e,t)=>{if("number"!=typeof t||!Number.isInteger(t))throw new Y(`${e} must be an integer`);if(t<0)throw new Y(`${e} must be a positive integer`);return t},tt=e=>{if(e instanceof Error)return e;if("object"==typeof e&&null!==e)try{return new Error(JSON.stringify(e))}catch{}return new Error(e)},nt=e=>"undefined"!=typeof process?process.env?.[e]?.trim()??void 0:"undefined"!=typeof Deno?Deno.env?.get?.(e)?.trim():void 0;function st(e){if(!e)return!0;for(const t in e)return!1;return!0}function rt(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function ot(e,t){for(const n in t){if(!rt(t,n))continue;const s=n.toLowerCase();if(!s)continue;const r=t[n];null===r?delete e[s]:void 0!==r&&(e[s]=r)}}const it=new Set(["authorization","api-key"]);function at(e,...t){if("undefined"!=typeof process&&"true"===process?.env?.DEBUG){const n=t.map(e=>{if(!e)return e;if(e.headers){const t={...e,headers:{...e.headers}};for(const n in e.headers)it.has(n.toLowerCase())&&(t.headers[n]="REDACTED");return t}let t=null;for(const n in e)it.has(n.toLowerCase())&&(t??(t={...e}),t[n]="REDACTED");return t??e});console.log(`OpenAI:DEBUG:${e}`,...n)}}const lt=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}),ct=(e,t)=>{const n=t.toLowerCase();if((e=>"function"==typeof e?.get)(e)){const s=t[0]?.toUpperCase()+t.substring(1).replace(/([^\w])(\w)/g,(e,t,n)=>t+n.toUpperCase());for(const r of[t,n,t.toUpperCase(),s]){const t=e.get(r);if(t)return t}}for(const[s,r]of Object.entries(e))if(s.toLowerCase()===n)return Array.isArray(r)?(r.length<=1||console.warn(`Received ${r.length} entries for the ${t} header, using the first entry.`),r[0]):r};function ut(e){return null!=e&&"object"==typeof e&&!Array.isArray(e)}class dt{constructor(e){this._client=e}}class ht extends dt{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}}class pt extends dt{list(e,t={},n){return Je(t)?this.list(e,{},t):this._client.getAPIList(`/chat/completions/${e}/messages`,wt,{query:t,...n})}}class ft extends qe{constructor(e,t,n,s){super(e,t,n,s),this.data=n.data||[],this.object=n.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}}class mt extends qe{constructor(e,t,n,s){super(e,t,n,s),this.data=n.data||[],this.has_more=n.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return!1!==this.has_more&&super.hasNextPage()}nextPageParams(){const e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;const t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){const e=this.getPaginatedItems();if(!e.length)return null;const t=e[e.length-1]?.id;return t?{params:{after:t}}:null}}class yt extends dt{constructor(){super(...arguments),this.messages=new pt(this._client)}create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}retrieve(e,t){return this._client.get(`/chat/completions/${e}`,t)}update(e,t,n){return this._client.post(`/chat/completions/${e}`,{body:t,...n})}list(e={},t){return Je(e)?this.list({},e):this._client.getAPIList("/chat/completions",gt,{query:e,...t})}del(e,t){return this._client.delete(`/chat/completions/${e}`,t)}}class gt extends mt{}class wt extends mt{}yt.ChatCompletionsPage=gt,yt.Messages=pt;class vt extends dt{constructor(){super(...arguments),this.completions=new yt(this._client)}}vt.Completions=yt,vt.ChatCompletionsPage=gt;class _t extends dt{create(e,t){const n=!!e.encoding_format;let s=n?e.encoding_format:"base64";n&&at("Request","User defined encoding_format:",e.encoding_format);const r=this._client.post("/embeddings",{body:{...e,encoding_format:s},...t});return n?r:(at("response","Decoding base64 embeddings to float32 array"),r._thenUnwrap(e=>(e&&e.data&&e.data.forEach(e=>{const t=e.embedding;e.embedding=(e=>{if("undefined"!=typeof Buffer){const t=Buffer.from(e,"base64");return Array.from(new Float32Array(t.buffer,t.byteOffset,t.length/Float32Array.BYTES_PER_ELEMENT))}{const t=atob(e),n=t.length,s=new Uint8Array(n);for(let e=0;e<n;e++)s[e]=t.charCodeAt(e);return Array.from(new Float32Array(s.buffer))}})(t)}),e)))}}class bt extends dt{create(e,t){return this._client.post("/files",Ce({body:e,...t}))}retrieve(e,t){return this._client.get(`/files/${e}`,t)}list(e={},t){return Je(e)?this.list({},e):this._client.getAPIList("/files",Et,{query:e,...t})}del(e,t){return this._client.delete(`/files/${e}`,t)}content(e,t){return this._client.get(`/files/${e}/content`,{...t,headers:{Accept:"application/binary",...t?.headers},__binaryResponse:!0})}retrieveContent(e,t){return this._client.get(`/files/${e}/content`,t)}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:n=18e5}={}){const s=new Set(["processed","error","deleted"]),r=Date.now();let o=await this.retrieve(e);for(;!o.status||!s.has(o.status);)if(await Ze(t),o=await this.retrieve(e),Date.now()-r>n)throw new ne({message:`Giving up on waiting for file ${e} to finish processing after ${n} milliseconds.`});return o}}class Et extends mt{}bt.FileObjectsPage=Et;class xt extends dt{createVariation(e,t){return this._client.post("/images/variations",Ce({body:e,...t}))}edit(e,t){return this._client.post("/images/edits",Ce({body:e,...t}))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}}class At extends dt{create(e,t){return this._client.post("/audio/speech",{body:e,...t,headers:{Accept:"application/octet-stream",...t?.headers},__binaryResponse:!0})}}class It extends dt{create(e,t){return this._client.post("/audio/transcriptions",Ce({body:e,...t,stream:e.stream??!1,__metadata:{model:e.model}}))}}class St extends dt{create(e,t){return this._client.post("/audio/translations",Ce({body:e,...t,__metadata:{model:e.model}}))}}class Pt extends dt{constructor(){super(...arguments),this.transcriptions=new It(this._client),this.translations=new St(this._client),this.speech=new At(this._client)}}Pt.Transcriptions=It,Pt.Translations=St,Pt.Speech=At;class Rt extends dt{create(e,t){return this._client.post("/moderations",{body:e,...t})}}class Ot extends dt{retrieve(e,t){return this._client.get(`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",Ct,e)}del(e,t){return this._client.delete(`/models/${e}`,t)}}class Ct extends ft{}Ot.ModelsPage=Ct;class kt extends dt{}class Tt extends dt{run(e,t){return this._client.post("/fine_tuning/alpha/graders/run",{body:e,...t})}validate(e,t){return this._client.post("/fine_tuning/alpha/graders/validate",{body:e,...t})}}class $t extends dt{constructor(){super(...arguments),this.graders=new Tt(this._client)}}$t.Graders=Tt;class Nt extends dt{create(e,t,n){return this._client.getAPIList(`/fine_tuning/checkpoints/${e}/permissions`,Dt,{body:t,method:"post",...n})}retrieve(e,t={},n){return Je(t)?this.retrieve(e,{},t):this._client.get(`/fine_tuning/checkpoints/${e}/permissions`,{query:t,...n})}del(e,t,n){return this._client.delete(`/fine_tuning/checkpoints/${e}/permissions/${t}`,n)}}class Dt extends ft{}Nt.PermissionCreateResponsesPage=Dt;class Mt extends dt{constructor(){super(...arguments),this.permissions=new Nt(this._client)}}Mt.Permissions=Nt,Mt.PermissionCreateResponsesPage=Dt;class jt extends dt{list(e,t={},n){return Je(t)?this.list(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/checkpoints`,Ut,{query:t,...n})}}class Ut extends mt{}jt.FineTuningJobCheckpointsPage=Ut;class Lt extends dt{constructor(){super(...arguments),this.checkpoints=new jt(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine_tuning/jobs/${e}`,t)}list(e={},t){return Je(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",qt,{query:e,...t})}cancel(e,t){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},n){return Je(t)?this.listEvents(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,Bt,{query:t,...n})}pause(e,t){return this._client.post(`/fine_tuning/jobs/${e}/pause`,t)}resume(e,t){return this._client.post(`/fine_tuning/jobs/${e}/resume`,t)}}class qt extends mt{}class Bt extends mt{}Lt.FineTuningJobsPage=qt,Lt.FineTuningJobEventsPage=Bt,Lt.Checkpoints=jt,Lt.FineTuningJobCheckpointsPage=Ut;class Ft extends dt{constructor(){super(...arguments),this.methods=new kt(this._client),this.jobs=new Lt(this._client),this.checkpoints=new Mt(this._client),this.alpha=new $t(this._client)}}Ft.Methods=kt,Ft.Jobs=Lt,Ft.FineTuningJobsPage=qt,Ft.FineTuningJobEventsPage=Bt,Ft.Checkpoints=Mt,Ft.Alpha=$t;class Wt extends dt{}class Jt extends dt{constructor(){super(...arguments),this.graderModels=new Wt(this._client)}}Jt.GraderModels=Wt;class Xt extends dt{create(e,t,n){return this._client.post(`/vector_stores/${e}/files`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/vector_stores/${e}/files/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,t,n,s){return this._client.post(`/vector_stores/${e}/files/${t}`,{body:n,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}list(e,t={},n){return Je(t)?this.list(e,{},t):this._client.getAPIList(`/vector_stores/${e}/files`,Vt,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t,n){return this._client.delete(`/vector_stores/${e}/files/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){const s=await this.create(e,t,n);return await this.poll(e,s.id,n)}async poll(e,t,n){const s={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(s["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const r=await this.retrieve(e,t,{...n,headers:s}).withResponse(),o=r.data;switch(o.status){case"in_progress":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=r.response.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await Ze(e);break;case"failed":case"completed":return o}}}async upload(e,t,n){const s=await this._client.files.create({file:t,purpose:"assistants"},n);return this.create(e,{file_id:s.id},n)}async uploadAndPoll(e,t,n){const s=await this.upload(e,t,n);return await this.poll(e,s.id,n)}content(e,t,n){return this._client.getAPIList(`/vector_stores/${e}/files/${t}/content`,Gt,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}}class Vt extends mt{}class Gt extends ft{}Xt.VectorStoreFilesPage=Vt,Xt.FileContentResponsesPage=Gt;class Ht extends dt{create(e,t,n){return this._client.post(`/vector_stores/${e}/file_batches`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/vector_stores/${e}/file_batches/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}cancel(e,t,n){return this._client.post(`/vector_stores/${e}/file_batches/${t}/cancel`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){const s=await this.create(e,t);return await this.poll(e,s.id,n)}listFiles(e,t,n={},s){return Je(n)?this.listFiles(e,t,{},n):this._client.getAPIList(`/vector_stores/${e}/file_batches/${t}/files`,Vt,{query:n,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}async poll(e,t,n){const s={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(s["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const{data:r,response:o}=await this.retrieve(e,t,{...n,headers:s}).withResponse();switch(r.status){case"in_progress":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=o.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await Ze(e);break;case"failed":case"cancelled":case"completed":return r}}}async uploadAndPoll(e,{files:t,fileIds:n=[]},s){if(null==t||0==t.length)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const r=s?.maxConcurrency??5,o=Math.min(r,t.length),i=this._client,a=t.values(),l=[...n];const c=Array(o).fill(a).map(async function(e){for(let t of e){const e=await i.files.create({file:t,purpose:"assistants"},s);l.push(e.id)}});return await(async e=>{const t=await Promise.allSettled(e),n=t.filter(e=>"rejected"===e.status);if(n.length){for(const e of n)console.error(e.reason);throw new Error(`${n.length} promise(s) failed - see the above errors`)}const s=[];for(const e of t)"fulfilled"===e.status&&s.push(e.value);return s})(c),await this.createAndPoll(e,{file_ids:l})}}class Kt extends dt{constructor(){super(...arguments),this.files=new Xt(this._client),this.fileBatches=new Ht(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/vector_stores/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e={},t){return Je(e)?this.list({},e):this._client.getAPIList("/vector_stores",zt,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}search(e,t,n){return this._client.getAPIList(`/vector_stores/${e}/search`,Qt,{body:t,method:"post",...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}}class zt extends mt{}class Qt extends ft{}Kt.VectorStoresPage=zt,Kt.VectorStoreSearchResponsesPage=Qt,Kt.Files=Xt,Kt.VectorStoreFilesPage=Vt,Kt.FileContentResponsesPage=Gt,Kt.FileBatches=Ht;class Yt extends dt{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/assistants/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e={},t){return Je(e)?this.list({},e):this._client.getAPIList("/assistants",Zt,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class Zt extends mt{}function en(e){return"function"==typeof e.parse}Yt.AssistantsPage=Zt;const tn=e=>"assistant"===e?.role,nn=e=>"function"===e?.role,sn=e=>"tool"===e?.role;var rn,on,an,ln,cn,un,dn,hn,pn,fn,mn,yn,gn,wn=function(e,t,n,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(e,n):r?r.value=n:t.set(e,n),n},vn=function(e,t,n,s){if("a"===n&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?s:"a"===n?s.call(e):s?s.value:t.get(e)};class _n{constructor(){rn.add(this),this.controller=new AbortController,on.set(this,void 0),an.set(this,()=>{}),ln.set(this,()=>{}),cn.set(this,void 0),un.set(this,()=>{}),dn.set(this,()=>{}),hn.set(this,{}),pn.set(this,!1),fn.set(this,!1),mn.set(this,!1),yn.set(this,!1),wn(this,on,new Promise((e,t)=>{wn(this,an,e,"f"),wn(this,ln,t,"f")}),"f"),wn(this,cn,new Promise((e,t)=>{wn(this,un,e,"f"),wn(this,dn,t,"f")}),"f"),vn(this,on,"f").catch(()=>{}),vn(this,cn,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},vn(this,rn,"m",gn).bind(this))},0)}_connected(){this.ended||(vn(this,an,"f").call(this),this._emit("connect"))}get ended(){return vn(this,pn,"f")}get errored(){return vn(this,fn,"f")}get aborted(){return vn(this,mn,"f")}abort(){this.controller.abort()}on(e,t){return(vn(this,hn,"f")[e]||(vn(this,hn,"f")[e]=[])).push({listener:t}),this}off(e,t){const n=vn(this,hn,"f")[e];if(!n)return this;const s=n.findIndex(e=>e.listener===t);return s>=0&&n.splice(s,1),this}once(e,t){return(vn(this,hn,"f")[e]||(vn(this,hn,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,n)=>{wn(this,yn,!0,"f"),"error"!==e&&this.once("error",n),this.once(e,t)})}async done(){wn(this,yn,!0,"f"),await vn(this,cn,"f")}_emit(e,...t){if(vn(this,pn,"f"))return;"end"===e&&(wn(this,pn,!0,"f"),vn(this,un,"f").call(this));const n=vn(this,hn,"f")[e];if(n&&(vn(this,hn,"f")[e]=n.filter(e=>!e.once),n.forEach(({listener:e})=>e(...t))),"abort"===e){const e=t[0];return vn(this,yn,"f")||n?.length||Promise.reject(e),vn(this,ln,"f").call(this,e),vn(this,dn,"f").call(this,e),void this._emit("end")}if("error"===e){const e=t[0];vn(this,yn,"f")||n?.length||Promise.reject(e),vn(this,ln,"f").call(this,e),vn(this,dn,"f").call(this,e),this._emit("end")}}_emitFinal(){}}function bn(e){return"auto-parseable-response-format"===e?.$brand}function En(e){return"auto-parseable-tool"===e?.$brand}function xn(e,t){const n=e.choices.map(e=>{if("length"===e.finish_reason)throw new de;if("content_filter"===e.finish_reason)throw new he;return{...e,message:{...e.message,...e.message.tool_calls?{tool_calls:e.message.tool_calls?.map(e=>function(e,t){const n=e.tools?.find(e=>e.function?.name===t.function.name);return{...t,function:{...t.function,parsed_arguments:En(n)?n.$parseRaw(t.function.arguments):n?.function.strict?JSON.parse(t.function.arguments):null}}}(t,e))??void 0}:void 0,parsed:e.message.content&&!e.message.refusal?An(t,e.message.content):null}}});return{...e,choices:n}}function An(e,t){if("json_schema"!==e.response_format?.type)return null;if("json_schema"===e.response_format?.type){if("$parseRaw"in e.response_format){return e.response_format.$parseRaw(t)}return JSON.parse(t)}return null}function In(e,t){if(!e)return!1;const n=e.tools?.find(e=>e.function?.name===t.function.name);return En(n)||n?.function.strict||!1}function Sn(e){return!!bn(e.response_format)||(e.tools?.some(e=>En(e)||"function"===e.type&&!0===e.function.strict)??!1)}on=new WeakMap,an=new WeakMap,ln=new WeakMap,cn=new WeakMap,un=new WeakMap,dn=new WeakMap,hn=new WeakMap,pn=new WeakMap,fn=new WeakMap,mn=new WeakMap,yn=new WeakMap,rn=new WeakSet,gn=function(e){if(wn(this,fn,!0,"f"),e instanceof Error&&"AbortError"===e.name&&(e=new ee),e instanceof ee)return wn(this,mn,!0,"f"),this._emit("abort",e);if(e instanceof Y)return this._emit("error",e);if(e instanceof Error){const t=new Y(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new Y(String(e)))};var Pn,Rn,On,Cn,kn,Tn,$n,Nn,Dn=function(e,t,n,s){if("a"===n&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?s:"a"===n?s.call(e):s?s.value:t.get(e)};const Mn=10;class jn extends _n{constructor(){super(...arguments),Pn.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){this._chatCompletions.push(e),this._emit("chatCompletion",e);const t=e.choices[0]?.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t)if(this._emit("message",e),(nn(e)||sn(e))&&e.content)this._emit("functionCallResult",e.content);else if(tn(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(tn(e)&&e.tool_calls)for(const t of e.tool_calls)"function"===t.type&&this._emit("functionCall",t.function)}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new Y("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),Dn(this,Pn,"m",Rn).call(this)}async finalMessage(){return await this.done(),Dn(this,Pn,"m",On).call(this)}async finalFunctionCall(){return await this.done(),Dn(this,Pn,"m",Cn).call(this)}async finalFunctionCallResult(){return await this.done(),Dn(this,Pn,"m",kn).call(this)}async totalUsage(){return await this.done(),Dn(this,Pn,"m",Tn).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const t=Dn(this,Pn,"m",On).call(this);t&&this._emit("finalMessage",t);const n=Dn(this,Pn,"m",Rn).call(this);n&&this._emit("finalContent",n);const s=Dn(this,Pn,"m",Cn).call(this);s&&this._emit("finalFunctionCall",s);const r=Dn(this,Pn,"m",kn).call(this);null!=r&&this._emit("finalFunctionCallResult",r),this._chatCompletions.some(e=>e.usage)&&this._emit("totalUsage",Dn(this,Pn,"m",Tn).call(this))}async _createChatCompletion(e,t,n){const s=n?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),Dn(this,Pn,"m",$n).call(this,t);const r=await e.chat.completions.create({...t,stream:!1},{...n,signal:this.controller.signal});return this._connected(),this._addChatCompletion(xn(r,t))}async _runChatCompletion(e,t,n){for(const e of t.messages)this._addMessage(e,!1);return await this._createChatCompletion(e,t,n)}async _runFunctions(e,t,n){const s="function",{function_call:r="auto",stream:o,...i}=t,a="string"!=typeof r&&r?.name,{maxChatCompletions:l=Mn}=n||{},c={};for(const e of t.functions)c[e.name||e.function.name]=e;const u=t.functions.map(e=>({name:e.name||e.function.name,parameters:e.parameters,description:e.description}));for(const e of t.messages)this._addMessage(e,!1);for(let t=0;t<l;++t){const t=await this._createChatCompletion(e,{...i,function_call:r,functions:u,messages:[...this.messages]},n),o=t.choices[0]?.message;if(!o)throw new Y("missing message in ChatCompletion response");if(!o.function_call)return;const{name:l,arguments:d}=o.function_call,h=c[l];if(!h){const e=`Invalid function_call: ${JSON.stringify(l)}. Available options are: ${u.map(e=>JSON.stringify(e.name)).join(", ")}. Please try again`;this._addMessage({role:s,name:l,content:e});continue}if(a&&a!==l){const e=`Invalid function_call: ${JSON.stringify(l)}. ${JSON.stringify(a)} requested. Please try again`;this._addMessage({role:s,name:l,content:e});continue}let p;try{p=en(h)?await h.parse(d):d}catch(e){this._addMessage({role:s,name:l,content:e instanceof Error?e.message:String(e)});continue}const f=await h.function(p,this),m=Dn(this,Pn,"m",Nn).call(this,f);if(this._addMessage({role:s,name:l,content:m}),a)return}}async _runTools(e,t,n){const s="tool",{tool_choice:r="auto",stream:o,...i}=t,a="string"!=typeof r&&r?.function?.name,{maxChatCompletions:l=Mn}=n||{},c=t.tools.map(e=>{if(En(e)){if(!e.$callback)throw new Y("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:e.$callback,name:e.function.name,description:e.function.description||"",parameters:e.function.parameters,parse:e.$parseRaw,strict:!0}}}return e}),u={};for(const e of c)"function"===e.type&&(u[e.function.name||e.function.function.name]=e.function);const d="tools"in t?c.map(e=>"function"===e.type?{type:"function",function:{name:e.function.name||e.function.function.name,parameters:e.function.parameters,description:e.function.description,strict:e.function.strict}}:e):void 0;for(const e of t.messages)this._addMessage(e,!1);for(let t=0;t<l;++t){const t=await this._createChatCompletion(e,{...i,tool_choice:r,tools:d,messages:[...this.messages]},n),o=t.choices[0]?.message;if(!o)throw new Y("missing message in ChatCompletion response");if(!o.tool_calls?.length)return;for(const e of o.tool_calls){if("function"!==e.type)continue;const t=e.id,{name:n,arguments:r}=e.function,o=u[n];if(!o){const e=`Invalid tool_call: ${JSON.stringify(n)}. Available options are: ${Object.keys(u).map(e=>JSON.stringify(e)).join(", ")}. Please try again`;this._addMessage({role:s,tool_call_id:t,content:e});continue}if(a&&a!==n){const e=`Invalid tool_call: ${JSON.stringify(n)}. ${JSON.stringify(a)} requested. Please try again`;this._addMessage({role:s,tool_call_id:t,content:e});continue}let i;try{i=en(o)?await o.parse(r):r}catch(e){const n=e instanceof Error?e.message:String(e);this._addMessage({role:s,tool_call_id:t,content:n});continue}const l=await o.function(i,this),c=Dn(this,Pn,"m",Nn).call(this,l);if(this._addMessage({role:s,tool_call_id:t,content:c}),a)return}}}}Pn=new WeakSet,Rn=function(){return Dn(this,Pn,"m",On).call(this).content??null},On=function(){let e=this.messages.length;for(;e-- >0;){const t=this.messages[e];if(tn(t)){const{function_call:e,...n}=t,s={...n,content:t.content??null,refusal:t.refusal??null};return e&&(s.function_call=e),s}}throw new Y("stream ended without producing a ChatCompletionMessage with role=assistant")},Cn=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(tn(t)&&t?.function_call)return t.function_call;if(tn(t)&&t?.tool_calls?.length)return t.tool_calls.at(-1)?.function}},kn=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(nn(t)&&null!=t.content)return t.content;if(sn(t)&&null!=t.content&&"string"==typeof t.content&&this.messages.some(e=>"assistant"===e.role&&e.tool_calls?.some(e=>"function"===e.type&&e.id===t.tool_call_id)))return t.content}},Tn=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},$n=function(e){if(null!=e.n&&e.n>1)throw new Y("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},Nn=function(e){return"string"==typeof e?e:void 0===e?"undefined":JSON.stringify(e)};class Un extends jn{static runFunctions(e,t,n){const s=new Un,r={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return s._run(()=>s._runFunctions(e,t,r)),s}static runTools(e,t,n){const s=new Un,r={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,t,r)),s}_addMessage(e,t=!0){super._addMessage(e,t),tn(e)&&e.content&&this._emit("content",e.content)}}const Ln=1,qn=2,Bn=4,Fn=8,Wn=16,Jn=32,Xn=64,Vn=128,Gn=256,Hn=511;class Kn extends Error{}class zn extends Error{}const Qn=(e,t)=>{const n=e.length;let s=0;const r=e=>{throw new Kn(`${e} at position ${s}`)},o=e=>{throw new zn(`${e} at position ${s}`)},i=()=>(d(),s>=n&&r("Unexpected end of input"),'"'===e[s]?a():"{"===e[s]?l():"["===e[s]?c():"null"===e.substring(s,s+4)||Wn&t&&n-s<4&&"null".startsWith(e.substring(s))?(s+=4,null):"true"===e.substring(s,s+4)||Jn&t&&n-s<4&&"true".startsWith(e.substring(s))?(s+=4,!0):"false"===e.substring(s,s+5)||Jn&t&&n-s<5&&"false".startsWith(e.substring(s))?(s+=5,!1):"Infinity"===e.substring(s,s+8)||Vn&t&&n-s<8&&"Infinity".startsWith(e.substring(s))?(s+=8,1/0):"-Infinity"===e.substring(s,s+9)||Gn&t&&1<n-s&&n-s<9&&"-Infinity".startsWith(e.substring(s))?(s+=9,-1/0):"NaN"===e.substring(s,s+3)||Xn&t&&n-s<3&&"NaN".startsWith(e.substring(s))?(s+=3,NaN):u()),a=()=>{const i=s;let a=!1;for(s++;s<n&&('"'!==e[s]||a&&"\\"===e[s-1]);)a="\\"===e[s]&&!a,s++;if('"'==e.charAt(s))try{return JSON.parse(e.substring(i,++s-Number(a)))}catch(e){o(String(e))}else if(Ln&t)try{return JSON.parse(e.substring(i,s-Number(a))+'"')}catch(t){return JSON.parse(e.substring(i,e.lastIndexOf("\\"))+'"')}r("Unterminated string literal")},l=()=>{s++,d();const o={};try{for(;"}"!==e[s];){if(d(),s>=n&&Fn&t)return o;const r=a();d(),s++;try{const e=i();Object.defineProperty(o,r,{value:e,writable:!0,enumerable:!0,configurable:!0})}catch(e){if(Fn&t)return o;throw e}d(),","===e[s]&&s++}}catch(e){if(Fn&t)return o;r("Expected '}' at end of object")}return s++,o},c=()=>{s++;const n=[];try{for(;"]"!==e[s];)n.push(i()),d(),","===e[s]&&s++}catch(e){if(Bn&t)return n;r("Expected ']' at end of array")}return s++,n},u=()=>{if(0===s){"-"===e&&qn&t&&r("Not sure what '-' is");try{return JSON.parse(e)}catch(n){if(qn&t)try{return"."===e[e.length-1]?JSON.parse(e.substring(0,e.lastIndexOf("."))):JSON.parse(e.substring(0,e.lastIndexOf("e")))}catch(e){}o(String(n))}}const i=s;for("-"===e[s]&&s++;e[s]&&!",]}".includes(e[s]);)s++;s!=n||qn&t||r("Unterminated number literal");try{return JSON.parse(e.substring(i,s))}catch(n){"-"===e.substring(i,s)&&qn&t&&r("Not sure what '-' is");try{return JSON.parse(e.substring(i,e.lastIndexOf("e")))}catch(e){o(String(e))}}},d=()=>{for(;s<n&&" \n\r\t".includes(e[s]);)s++};return i()},Yn=e=>function(e,t=Hn){if("string"!=typeof e)throw new TypeError("expecting str, got "+typeof e);if(!e.trim())throw new Error(`${e} is empty`);return Qn(e.trim(),t)}(e,Hn^qn);var Zn,es,ts,ns,ss,rs,os,is,as,ls,cs,us,ds=function(e,t,n,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(e,n):r?r.value=n:t.set(e,n),n},hs=function(e,t,n,s){if("a"===n&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?s:"a"===n?s.call(e):s?s.value:t.get(e)};class ps extends jn{constructor(e){super(),Zn.add(this),es.set(this,void 0),ts.set(this,void 0),ns.set(this,void 0),ds(this,es,e,"f"),ds(this,ts,[],"f")}get currentChatCompletionSnapshot(){return hs(this,ns,"f")}static fromReadableStream(e){const t=new ps(null);return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,n){const s=new ps(t);return s._run(()=>s._runChatCompletion(e,{...t,stream:!0},{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createChatCompletion(e,t,n){super._createChatCompletion;const s=n?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),hs(this,Zn,"m",ss).call(this);const r=await e.chat.completions.create({...t,stream:!0},{...n,signal:this.controller.signal});this._connected();for await(const e of r)hs(this,Zn,"m",os).call(this,e);if(r.controller.signal?.aborted)throw new ee;return this._addChatCompletion(hs(this,Zn,"m",ls).call(this))}async _fromReadableStream(e,t){const n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),hs(this,Zn,"m",ss).call(this),this._connected();const s=_e.fromReadableStream(e,this.controller);let r;for await(const e of s)r&&r!==e.id&&this._addChatCompletion(hs(this,Zn,"m",ls).call(this)),hs(this,Zn,"m",os).call(this,e),r=e.id;if(s.controller.signal?.aborted)throw new ee;return this._addChatCompletion(hs(this,Zn,"m",ls).call(this))}[(es=new WeakMap,ts=new WeakMap,ns=new WeakMap,Zn=new WeakSet,ss=function(){this.ended||ds(this,ns,void 0,"f")},rs=function(e){let t=hs(this,ts,"f")[e.index];return t||(t={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},hs(this,ts,"f")[e.index]=t,t)},os=function(e){if(this.ended)return;const t=hs(this,Zn,"m",us).call(this,e);this._emit("chunk",e,t);for(const n of e.choices){const e=t.choices[n.index];null!=n.delta.content&&"assistant"===e.message?.role&&e.message?.content&&(this._emit("content",n.delta.content,e.message.content),this._emit("content.delta",{delta:n.delta.content,snapshot:e.message.content,parsed:e.message.parsed})),null!=n.delta.refusal&&"assistant"===e.message?.role&&e.message?.refusal&&this._emit("refusal.delta",{delta:n.delta.refusal,snapshot:e.message.refusal}),null!=n.logprobs?.content&&"assistant"===e.message?.role&&this._emit("logprobs.content.delta",{content:n.logprobs?.content,snapshot:e.logprobs?.content??[]}),null!=n.logprobs?.refusal&&"assistant"===e.message?.role&&this._emit("logprobs.refusal.delta",{refusal:n.logprobs?.refusal,snapshot:e.logprobs?.refusal??[]});const s=hs(this,Zn,"m",rs).call(this,e);e.finish_reason&&(hs(this,Zn,"m",as).call(this,e),null!=s.current_tool_call_index&&hs(this,Zn,"m",is).call(this,e,s.current_tool_call_index));for(const t of n.delta.tool_calls??[])s.current_tool_call_index!==t.index&&(hs(this,Zn,"m",as).call(this,e),null!=s.current_tool_call_index&&hs(this,Zn,"m",is).call(this,e,s.current_tool_call_index)),s.current_tool_call_index=t.index;for(const t of n.delta.tool_calls??[]){const n=e.message.tool_calls?.[t.index];n?.type&&("function"===n?.type?this._emit("tool_calls.function.arguments.delta",{name:n.function?.name,index:t.index,arguments:n.function.arguments,parsed_arguments:n.function.parsed_arguments,arguments_delta:t.function?.arguments??""}):ys(n?.type))}}},is=function(e,t){if(hs(this,Zn,"m",rs).call(this,e).done_tool_calls.has(t))return;const n=e.message.tool_calls?.[t];if(!n)throw new Error("no tool call snapshot");if(!n.type)throw new Error("tool call snapshot missing `type`");if("function"===n.type){const e=hs(this,es,"f")?.tools?.find(e=>"function"===e.type&&e.function.name===n.function.name);this._emit("tool_calls.function.arguments.done",{name:n.function.name,index:t,arguments:n.function.arguments,parsed_arguments:En(e)?e.$parseRaw(n.function.arguments):e?.function.strict?JSON.parse(n.function.arguments):null})}else n.type},as=function(e){const t=hs(this,Zn,"m",rs).call(this,e);if(e.message.content&&!t.content_done){t.content_done=!0;const n=hs(this,Zn,"m",cs).call(this);this._emit("content.done",{content:e.message.content,parsed:n?n.$parseRaw(e.message.content):null})}e.message.refusal&&!t.refusal_done&&(t.refusal_done=!0,this._emit("refusal.done",{refusal:e.message.refusal})),e.logprobs?.content&&!t.logprobs_content_done&&(t.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:e.logprobs.content})),e.logprobs?.refusal&&!t.logprobs_refusal_done&&(t.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:e.logprobs.refusal}))},ls=function(){if(this.ended)throw new Y("stream has ended, this shouldn't happen");const e=hs(this,ns,"f");if(!e)throw new Y("request ended without sending any chunks");return ds(this,ns,void 0,"f"),ds(this,ts,[],"f"),function(e,t){const{id:n,choices:s,created:r,model:o,system_fingerprint:i,...a}=e,l={...a,id:n,choices:s.map(({message:t,finish_reason:n,index:s,logprobs:r,...o})=>{if(!n)throw new Y(`missing finish_reason for choice ${s}`);const{content:i=null,function_call:a,tool_calls:l,...c}=t,u=t.role;if(!u)throw new Y(`missing role for choice ${s}`);if(a){const{arguments:e,name:l}=a;if(null==e)throw new Y(`missing function_call.arguments for choice ${s}`);if(!l)throw new Y(`missing function_call.name for choice ${s}`);return{...o,message:{content:i,function_call:{arguments:e,name:l},role:u,refusal:t.refusal??null},finish_reason:n,index:s,logprobs:r}}return l?{...o,index:s,finish_reason:n,logprobs:r,message:{...c,role:u,content:i,refusal:t.refusal??null,tool_calls:l.map((t,n)=>{const{function:r,type:o,id:i,...a}=t,{arguments:l,name:c,...u}=r||{};if(null==i)throw new Y(`missing choices[${s}].tool_calls[${n}].id\n${fs(e)}`);if(null==o)throw new Y(`missing choices[${s}].tool_calls[${n}].type\n${fs(e)}`);if(null==c)throw new Y(`missing choices[${s}].tool_calls[${n}].function.name\n${fs(e)}`);if(null==l)throw new Y(`missing choices[${s}].tool_calls[${n}].function.arguments\n${fs(e)}`);return{...a,id:i,type:o,function:{...u,name:c,arguments:l}}})}}:{...o,message:{...c,content:i,role:u,refusal:t.refusal??null},finish_reason:n,index:s,logprobs:r}}),created:r,model:o,object:"chat.completion",...i?{system_fingerprint:i}:{}};return function(e,t){return t&&Sn(t)?xn(e,t):{...e,choices:e.choices.map(e=>({...e,message:{...e.message,parsed:null,...e.message.tool_calls?{tool_calls:e.message.tool_calls}:void 0}}))}}(l,t)}(e,hs(this,es,"f"))},cs=function(){const e=hs(this,es,"f")?.response_format;return bn(e)?e:null},us=function(e){var t,n,s,r;let o=hs(this,ns,"f");const{choices:i,...a}=e;o?Object.assign(o,a):o=ds(this,ns,{...a,choices:[]},"f");for(const{delta:i,finish_reason:a,index:l,logprobs:c=null,...u}of e.choices){let e=o.choices[l];if(e||(e=o.choices[l]={finish_reason:a,index:l,message:{},logprobs:c,...u}),c)if(e.logprobs){const{content:s,refusal:r,...o}=c;ms(o),Object.assign(e.logprobs,o),s&&((t=e.logprobs).content??(t.content=[]),e.logprobs.content.push(...s)),r&&((n=e.logprobs).refusal??(n.refusal=[]),e.logprobs.refusal.push(...r))}else e.logprobs=Object.assign({},c);if(a&&(e.finish_reason=a,hs(this,es,"f")&&Sn(hs(this,es,"f")))){if("length"===a)throw new de;if("content_filter"===a)throw new he}if(Object.assign(e,u),!i)continue;const{content:d,refusal:h,function_call:p,role:f,tool_calls:m,...y}=i;if(ms(y),Object.assign(e.message,y),h&&(e.message.refusal=(e.message.refusal||"")+h),f&&(e.message.role=f),p&&(e.message.function_call?(p.name&&(e.message.function_call.name=p.name),p.arguments&&((s=e.message.function_call).arguments??(s.arguments=""),e.message.function_call.arguments+=p.arguments)):e.message.function_call=p),d&&(e.message.content=(e.message.content||"")+d,!e.message.refusal&&hs(this,Zn,"m",cs).call(this)&&(e.message.parsed=Yn(e.message.content))),m){e.message.tool_calls||(e.message.tool_calls=[]);for(const{index:t,id:n,type:s,function:o,...i}of m){const a=(r=e.message.tool_calls)[t]??(r[t]={});Object.assign(a,i),n&&(a.id=n),s&&(a.type=s),o&&(a.function??(a.function={name:o.name??"",arguments:""})),o?.name&&(a.function.name=o.name),o?.arguments&&(a.function.arguments+=o.arguments,In(hs(this,es,"f"),a)&&(a.function.parsed_arguments=Yn(a.function.arguments)))}}}return o},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("chunk",n=>{const s=t.shift();s?s.resolve(n):e.push(n)}),this.on("end",()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0}),this.on("abort",e=>{n=!0;for(const n of t)n.reject(e);t.length=0}),this.on("error",e=>{n=!0;for(const n of t)n.reject(e);t.length=0}),{next:async()=>{if(!e.length)return n?{value:void 0,done:!0}:new Promise((e,n)=>t.push({resolve:e,reject:n})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0});return{value:e.shift(),done:!1}},return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new _e(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function fs(e){return JSON.stringify(e)}function ms(e){}function ys(e){}class gs extends ps{static fromReadableStream(e){const t=new gs(null);return t._run(()=>t._fromReadableStream(e)),t}static runFunctions(e,t,n){const s=new gs(null),r={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return s._run(()=>s._runFunctions(e,t,r)),s}static runTools(e,t,n){const s=new gs(t),r={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,t,r)),s}}class ws extends dt{parse(e,t){return function(e){for(const t of e??[]){if("function"!==t.type)throw new Y(`Currently only \`function\` tool types support auto-parsing; Received \`${t.type}\``);if(!0!==t.function.strict)throw new Y(`The \`${t.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}(e.tools),this._client.chat.completions.create(e,{...t,headers:{...t?.headers,"X-Stainless-Helper-Method":"beta.chat.completions.parse"}})._thenUnwrap(t=>xn(t,e))}runFunctions(e,t){return e.stream?gs.runFunctions(this._client,e,t):Un.runFunctions(this._client,e,t)}runTools(e,t){return e.stream?gs.runTools(this._client,e,t):Un.runTools(this._client,e,t)}stream(e,t){return ps.createChatCompletion(this._client,e,t)}}class vs extends dt{constructor(){super(...arguments),this.completions=new ws(this._client)}}!function(e){e.Completions=ws}(vs||(vs={}));class _s extends dt{create(e,t){return this._client.post("/realtime/sessions",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class bs extends dt{create(e,t){return this._client.post("/realtime/transcription_sessions",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class Es extends dt{constructor(){super(...arguments),this.sessions=new _s(this._client),this.transcriptionSessions=new bs(this._client)}}Es.Sessions=_s,Es.TranscriptionSessions=bs;var xs,As,Is,Ss,Ps,Rs,Os,Cs,ks,Ts,$s,Ns,Ds,Ms,js,Us,Ls,qs,Bs,Fs,Ws,Js,Xs=function(e,t,n,s){if("a"===n&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?s:"a"===n?s.call(e):s?s.value:t.get(e)},Vs=function(e,t,n,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(e,n):r?r.value=n:t.set(e,n),n};class Gs extends _n{constructor(){super(...arguments),xs.add(this),As.set(this,[]),Is.set(this,{}),Ss.set(this,{}),Ps.set(this,void 0),Rs.set(this,void 0),Os.set(this,void 0),Cs.set(this,void 0),ks.set(this,void 0),Ts.set(this,void 0),$s.set(this,void 0),Ns.set(this,void 0),Ds.set(this,void 0)}[(As=new WeakMap,Is=new WeakMap,Ss=new WeakMap,Ps=new WeakMap,Rs=new WeakMap,Os=new WeakMap,Cs=new WeakMap,ks=new WeakMap,Ts=new WeakMap,$s=new WeakMap,Ns=new WeakMap,Ds=new WeakMap,xs=new WeakSet,Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("event",n=>{const s=t.shift();s?s.resolve(n):e.push(n)}),this.on("end",()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0}),this.on("abort",e=>{n=!0;for(const n of t)n.reject(e);t.length=0}),this.on("error",e=>{n=!0;for(const n of t)n.reject(e);t.length=0}),{next:async()=>{if(!e.length)return n?{value:void 0,done:!0}:new Promise((e,n)=>t.push({resolve:e,reject:n})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0});return{value:e.shift(),done:!1}},return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const t=new Gs;return t._run(()=>t._fromReadableStream(e)),t}async _fromReadableStream(e,t){const n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),this._connected();const s=_e.fromReadableStream(e,this.controller);for await(const e of s)Xs(this,xs,"m",Ms).call(this,e);if(s.controller.signal?.aborted)throw new ee;return this._addRun(Xs(this,xs,"m",js).call(this))}toReadableStream(){return new _e(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,n,s,r){const o=new Gs;return o._run(()=>o._runToolAssistantStream(e,t,n,s,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),o}async _createToolAssistantStream(e,t,n,s,r){const o=r?.signal;o&&(o.aborted&&this.controller.abort(),o.addEventListener("abort",()=>this.controller.abort()));const i={...s,stream:!0},a=await e.submitToolOutputs(t,n,i,{...r,signal:this.controller.signal});this._connected();for await(const e of a)Xs(this,xs,"m",Ms).call(this,e);if(a.controller.signal?.aborted)throw new ee;return this._addRun(Xs(this,xs,"m",js).call(this))}static createThreadAssistantStream(e,t,n){const s=new Gs;return s._run(()=>s._threadAssistantStream(e,t,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),s}static createAssistantStream(e,t,n,s){const r=new Gs;return r._run(()=>r._runAssistantStream(e,t,n,{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),r}currentEvent(){return Xs(this,$s,"f")}currentRun(){return Xs(this,Ns,"f")}currentMessageSnapshot(){return Xs(this,Ps,"f")}currentRunStepSnapshot(){return Xs(this,Ds,"f")}async finalRunSteps(){return await this.done(),Object.values(Xs(this,Is,"f"))}async finalMessages(){return await this.done(),Object.values(Xs(this,Ss,"f"))}async finalRun(){if(await this.done(),!Xs(this,Rs,"f"))throw Error("Final run was not received.");return Xs(this,Rs,"f")}async _createThreadAssistantStream(e,t,n){const s=n?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort()));const r={...t,stream:!0},o=await e.createAndRun(r,{...n,signal:this.controller.signal});this._connected();for await(const e of o)Xs(this,xs,"m",Ms).call(this,e);if(o.controller.signal?.aborted)throw new ee;return this._addRun(Xs(this,xs,"m",js).call(this))}async _createAssistantStream(e,t,n,s){const r=s?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort()));const o={...n,stream:!0},i=await e.create(t,o,{...s,signal:this.controller.signal});this._connected();for await(const e of i)Xs(this,xs,"m",Ms).call(this,e);if(i.controller.signal?.aborted)throw new ee;return this._addRun(Xs(this,xs,"m",js).call(this))}static accumulateDelta(e,t){for(const[n,s]of Object.entries(t)){if(!e.hasOwnProperty(n)){e[n]=s;continue}let t=e[n];if(null!=t)if("index"!==n&&"type"!==n){if("string"==typeof t&&"string"==typeof s)t+=s;else if("number"==typeof t&&"number"==typeof s)t+=s;else{if(!ut(t)||!ut(s)){if(Array.isArray(t)&&Array.isArray(s)){if(t.every(e=>"string"==typeof e||"number"==typeof e)){t.push(...s);continue}for(const e of s){if(!ut(e))throw new Error(`Expected array delta entry to be an object but got: ${e}`);const n=e.index;if(null==n)throw console.error(e),new Error("Expected array delta entry to have an `index` property");if("number"!=typeof n)throw new Error(`Expected array delta entry \`index\` property to be a number but got ${n}`);const s=t[n];null==s?t.push(e):t[n]=this.accumulateDelta(s,e)}continue}throw Error(`Unhandled record type: ${n}, deltaValue: ${s}, accValue: ${t}`)}t=this.accumulateDelta(t,s)}e[n]=t}else e[n]=s;else e[n]=s}return e}_addRun(e){return e}async _threadAssistantStream(e,t,n){return await this._createThreadAssistantStream(t,e,n)}async _runAssistantStream(e,t,n,s){return await this._createAssistantStream(t,e,n,s)}async _runToolAssistantStream(e,t,n,s,r){return await this._createToolAssistantStream(n,e,t,s,r)}}Ms=function(e){if(!this.ended)switch(Vs(this,$s,e,"f"),Xs(this,xs,"m",qs).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":Xs(this,xs,"m",Js).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":Xs(this,xs,"m",Ls).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":Xs(this,xs,"m",Us).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},js=function(){if(this.ended)throw new Y("stream has ended, this shouldn't happen");if(!Xs(this,Rs,"f"))throw Error("Final run has not been received");return Xs(this,Rs,"f")},Us=function(e){const[t,n]=Xs(this,xs,"m",Fs).call(this,e,Xs(this,Ps,"f"));Vs(this,Ps,t,"f"),Xs(this,Ss,"f")[t.id]=t;for(const e of n){const n=t.content[e.index];"text"==n?.type&&this._emit("textCreated",n.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(const n of e.data.delta.content){if("text"==n.type&&n.text){let e=n.text,s=t.content[n.index];if(!s||"text"!=s.type)throw Error("The snapshot associated with this text delta is not text or missing");this._emit("textDelta",e,s.text)}if(n.index!=Xs(this,Os,"f")){if(Xs(this,Cs,"f"))switch(Xs(this,Cs,"f").type){case"text":this._emit("textDone",Xs(this,Cs,"f").text,Xs(this,Ps,"f"));break;case"image_file":this._emit("imageFileDone",Xs(this,Cs,"f").image_file,Xs(this,Ps,"f"))}Vs(this,Os,n.index,"f")}Vs(this,Cs,t.content[n.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(void 0!==Xs(this,Os,"f")){const t=e.data.content[Xs(this,Os,"f")];if(t)switch(t.type){case"image_file":this._emit("imageFileDone",t.image_file,Xs(this,Ps,"f"));break;case"text":this._emit("textDone",t.text,Xs(this,Ps,"f"))}}Xs(this,Ps,"f")&&this._emit("messageDone",e.data),Vs(this,Ps,void 0,"f")}},Ls=function(e){const t=Xs(this,xs,"m",Bs).call(this,e);switch(Vs(this,Ds,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const n=e.data.delta;if(n.step_details&&"tool_calls"==n.step_details.type&&n.step_details.tool_calls&&"tool_calls"==t.step_details.type)for(const e of n.step_details.tool_calls)e.index==Xs(this,ks,"f")?this._emit("toolCallDelta",e,t.step_details.tool_calls[e.index]):(Xs(this,Ts,"f")&&this._emit("toolCallDone",Xs(this,Ts,"f")),Vs(this,ks,e.index,"f"),Vs(this,Ts,t.step_details.tool_calls[e.index],"f"),Xs(this,Ts,"f")&&this._emit("toolCallCreated",Xs(this,Ts,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":Vs(this,Ds,void 0,"f");"tool_calls"==e.data.step_details.type&&Xs(this,Ts,"f")&&(this._emit("toolCallDone",Xs(this,Ts,"f")),Vs(this,Ts,void 0,"f")),this._emit("runStepDone",e.data,t)}},qs=function(e){Xs(this,As,"f").push(e),this._emit("event",e)},Bs=function(e){switch(e.event){case"thread.run.step.created":return Xs(this,Is,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=Xs(this,Is,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let n=e.data;if(n.delta){const s=Gs.accumulateDelta(t,n.delta);Xs(this,Is,"f")[e.data.id]=s}return Xs(this,Is,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":Xs(this,Is,"f")[e.data.id]=e.data}if(Xs(this,Is,"f")[e.data.id])return Xs(this,Is,"f")[e.data.id];throw new Error("No snapshot available")},Fs=function(e,t){let n=[];switch(e.event){case"thread.message.created":return[e.data,n];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let s=e.data;if(s.delta.content)for(const e of s.delta.content)if(e.index in t.content){let n=t.content[e.index];t.content[e.index]=Xs(this,xs,"m",Ws).call(this,e,n)}else t.content[e.index]=e,n.push(e);return[t,n];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,n];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},Ws=function(e,t){return Gs.accumulateDelta(t,e)},Js=function(e){switch(Vs(this,Ns,e.data,"f"),e.event){case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.cancelling":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":Vs(this,Rs,e.data,"f"),Xs(this,Ts,"f")&&(this._emit("toolCallDone",Xs(this,Ts,"f")),Vs(this,Ts,void 0,"f"))}};class Hs extends dt{create(e,t,n){return this._client.post(`/threads/${e}/messages`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/threads/${e}/messages/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,t,n,s){return this._client.post(`/threads/${e}/messages/${t}`,{body:n,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}list(e,t={},n){return Je(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/messages`,Ks,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t,n){return this._client.delete(`/threads/${e}/messages/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}}class Ks extends mt{}Hs.MessagesPage=Ks;class zs extends dt{retrieve(e,t,n,s={},r){return Je(s)?this.retrieve(e,t,n,{},s):this._client.get(`/threads/${e}/runs/${t}/steps/${n}`,{query:s,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e,t,n={},s){return Je(n)?this.list(e,t,{},n):this._client.getAPIList(`/threads/${e}/runs/${t}/steps`,Qs,{query:n,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}}class Qs extends mt{}zs.RunStepsPage=Qs;class Ys extends dt{constructor(){super(...arguments),this.steps=new zs(this._client)}create(e,t,n){const{include:s,...r}=t;return this._client.post(`/threads/${e}/runs`,{query:{include:s},body:r,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers},stream:t.stream??!1})}retrieve(e,t,n){return this._client.get(`/threads/${e}/runs/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,t,n,s){return this._client.post(`/threads/${e}/runs/${t}`,{body:n,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}list(e,t={},n){return Je(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/runs`,Zs,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}cancel(e,t,n){return this._client.post(`/threads/${e}/runs/${t}/cancel`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){const s=await this.create(e,t,n);return await this.poll(e,s.id,n)}createAndStream(e,t,n){return Gs.createAssistantStream(e,this._client.beta.threads.runs,t,n)}async poll(e,t,n){const s={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(s["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const{data:r,response:o}=await this.retrieve(e,t,{...n,headers:{...n?.headers,...s}}).withResponse();switch(r.status){case"queued":case"in_progress":case"cancelling":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=o.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await Ze(e);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return r}}}stream(e,t,n){return Gs.createAssistantStream(e,this._client.beta.threads.runs,t,n)}submitToolOutputs(e,t,n,s){return this._client.post(`/threads/${e}/runs/${t}/submit_tool_outputs`,{body:n,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers},stream:n.stream??!1})}async submitToolOutputsAndPoll(e,t,n,s){const r=await this.submitToolOutputs(e,t,n,s);return await this.poll(e,r.id,s)}submitToolOutputsStream(e,t,n,s){return Gs.createToolAssistantStream(e,t,this._client.beta.threads.runs,n,s)}}class Zs extends mt{}Ys.RunsPage=Zs,Ys.Steps=zs,Ys.RunStepsPage=Qs;class er extends dt{constructor(){super(...arguments),this.runs=new Ys(this._client),this.messages=new Hs(this._client)}create(e={},t){return Je(e)?this.create({},e):this._client.post("/threads",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/threads/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t){return this._client.delete(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers},stream:e.stream??!1})}async createAndRunPoll(e,t){const n=await this.createAndRun(e,t);return await this.runs.poll(n.thread_id,n.id,t)}createAndRunStream(e,t){return Gs.createThreadAssistantStream(e,this._client.beta.threads,t)}}er.Runs=Ys,er.RunsPage=Zs,er.Messages=Hs,er.MessagesPage=Ks;class tr extends dt{constructor(){super(...arguments),this.realtime=new Es(this._client),this.chat=new vs(this._client),this.assistants=new Yt(this._client),this.threads=new er(this._client)}}tr.Realtime=Es,tr.Assistants=Yt,tr.AssistantsPage=Zt,tr.Threads=er;class nr extends dt{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/batches/${e}`,t)}list(e={},t){return Je(e)?this.list({},e):this._client.getAPIList("/batches",sr,{query:e,...t})}cancel(e,t){return this._client.post(`/batches/${e}/cancel`,t)}}class sr extends mt{}nr.BatchesPage=sr;class rr extends dt{create(e,t,n){return this._client.post(`/uploads/${e}/parts`,Ce({body:t,...n}))}}class or extends dt{constructor(){super(...arguments),this.parts=new rr(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(`/uploads/${e}/cancel`,t)}complete(e,t,n){return this._client.post(`/uploads/${e}/complete`,{body:t,...n})}}function ir(e,t){return t&&function(e){if(bn(e.text?.format))return!0;return!1}(t)?ar(e,t):{...e,output_parsed:null,output:e.output.map(e=>"function_call"===e.type?{...e,parsed_arguments:null}:"message"===e.type?{...e,content:e.content.map(e=>({...e,parsed:null}))}:e)}}function ar(e,t){const n=e.output.map(e=>{if("function_call"===e.type)return{...e,parsed_arguments:dr(t,e)};if("message"===e.type){const n=e.content.map(e=>"output_text"===e.type?{...e,parsed:lr(t,e.text)}:e);return{...e,content:n}}return e}),s=Object.assign({},e,{output:n});return Object.getOwnPropertyDescriptor(e,"output_text")||hr(s),Object.defineProperty(s,"output_parsed",{enumerable:!0,get(){for(const e of s.output)if("message"===e.type)for(const t of e.content)if("output_text"===t.type&&null!==t.parsed)return t.parsed;return null}}),s}function lr(e,t){if("json_schema"!==e.text?.format?.type)return null;if("$parseRaw"in e.text?.format){const n=e.text?.format;return n.$parseRaw(t)}return JSON.parse(t)}function cr(e){return"auto-parseable-tool"===e?.$brand}function ur(e,t){return e.find(e=>"function"===e.type&&e.name===t)}function dr(e,t){const n=ur(e.tools??[],t.name);return{...t,...t,parsed_arguments:cr(n)?n.$parseRaw(t.arguments):n?.strict?JSON.parse(t.arguments):null}}function hr(e){const t=[];for(const n of e.output)if("message"===n.type)for(const e of n.content)"output_text"===e.type&&t.push(e.text);e.output_text=t.join("")}or.Parts=rr;class pr extends dt{list(e,t={},n){return Je(t)?this.list(e,{},t):this._client.getAPIList(`/responses/${e}/input_items`,Pr,{query:t,...n})}}var fr,mr,yr,gr,wr,vr,_r,br,Er,xr=function(e,t,n,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(e,n):r?r.value=n:t.set(e,n),n},Ar=function(e,t,n,s){if("a"===n&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?s:"a"===n?s.call(e):s?s.value:t.get(e)};class Ir extends _n{constructor(e){super(),fr.add(this),mr.set(this,void 0),yr.set(this,void 0),gr.set(this,void 0),xr(this,mr,e,"f")}static createResponse(e,t,n){const s=new Ir(t);return s._run(()=>s._createOrRetrieveResponse(e,t,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createOrRetrieveResponse(e,t,n){const s=n?.signal;let r;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),Ar(this,fr,"m",wr).call(this);let o=null;"response_id"in t?(r=await e.responses.retrieve(t.response_id,{stream:!0},{...n,signal:this.controller.signal,stream:!0}),o=t.starting_after??null):r=await e.responses.create({...t,stream:!0},{...n,signal:this.controller.signal}),this._connected();for await(const e of r)Ar(this,fr,"m",vr).call(this,e,o);if(r.controller.signal?.aborted)throw new ee;return Ar(this,fr,"m",_r).call(this)}[(mr=new WeakMap,yr=new WeakMap,gr=new WeakMap,fr=new WeakSet,wr=function(){this.ended||xr(this,yr,void 0,"f")},vr=function(e,t){if(this.ended)return;const n=(e,n)=>{(null==t||n.sequence_number>t)&&this._emit(e,n)},s=Ar(this,fr,"m",br).call(this,e);switch(n("event",e),e.type){case"response.output_text.delta":{const t=s.output[e.output_index];if(!t)throw new Y(`missing output at index ${e.output_index}`);if("message"===t.type){const s=t.content[e.content_index];if(!s)throw new Y(`missing content at index ${e.content_index}`);if("output_text"!==s.type)throw new Y(`expected content to be 'output_text', got ${s.type}`);n("response.output_text.delta",{...e,snapshot:s.text})}break}case"response.function_call_arguments.delta":{const t=s.output[e.output_index];if(!t)throw new Y(`missing output at index ${e.output_index}`);"function_call"===t.type&&n("response.function_call_arguments.delta",{...e,snapshot:t.arguments});break}default:n(e.type,e)}},_r=function(){if(this.ended)throw new Y("stream has ended, this shouldn't happen");const e=Ar(this,yr,"f");if(!e)throw new Y("request ended without sending any events");xr(this,yr,void 0,"f");const t=function(e,t){return ir(e,t)}(e,Ar(this,mr,"f"));return xr(this,gr,t,"f"),t},br=function(e){let t=Ar(this,yr,"f");if(!t){if("response.created"!==e.type)throw new Y(`When snapshot hasn't been set yet, expected 'response.created' event, got ${e.type}`);return t=xr(this,yr,e.response,"f"),t}switch(e.type){case"response.output_item.added":t.output.push(e.item);break;case"response.content_part.added":{const n=t.output[e.output_index];if(!n)throw new Y(`missing output at index ${e.output_index}`);"message"===n.type&&n.content.push(e.part);break}case"response.output_text.delta":{const n=t.output[e.output_index];if(!n)throw new Y(`missing output at index ${e.output_index}`);if("message"===n.type){const t=n.content[e.content_index];if(!t)throw new Y(`missing content at index ${e.content_index}`);if("output_text"!==t.type)throw new Y(`expected content to be 'output_text', got ${t.type}`);t.text+=e.delta}break}case"response.function_call_arguments.delta":{const n=t.output[e.output_index];if(!n)throw new Y(`missing output at index ${e.output_index}`);"function_call"===n.type&&(n.arguments+=e.delta);break}case"response.completed":xr(this,yr,e.response,"f")}return t},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("event",n=>{const s=t.shift();s?s.resolve(n):e.push(n)}),this.on("end",()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0}),this.on("abort",e=>{n=!0;for(const n of t)n.reject(e);t.length=0}),this.on("error",e=>{n=!0;for(const n of t)n.reject(e);t.length=0}),{next:async()=>{if(!e.length)return n?{value:void 0,done:!0}:new Promise((e,n)=>t.push({resolve:e,reject:n})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0});return{value:e.shift(),done:!1}},return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();const e=Ar(this,gr,"f");if(!e)throw new Y("stream ended without producing a ChatCompletion");return e}}class Sr extends dt{constructor(){super(...arguments),this.inputItems=new pr(this._client)}create(e,t){return this._client.post("/responses",{body:e,...t,stream:e.stream??!1})._thenUnwrap(e=>("object"in e&&"response"===e.object&&hr(e),e))}retrieve(e,t={},n){return this._client.get(`/responses/${e}`,{query:t,...n,stream:t?.stream??!1})}del(e,t){return this._client.delete(`/responses/${e}`,{...t,headers:{Accept:"*/*",...t?.headers}})}parse(e,t){return this._client.responses.create(e,t)._thenUnwrap(t=>ar(t,e))}stream(e,t){return Ir.createResponse(this._client,e,t)}cancel(e,t){return this._client.post(`/responses/${e}/cancel`,{...t,headers:{Accept:"*/*",...t?.headers}})}}class Pr extends mt{}Sr.InputItems=pr;class Rr extends dt{retrieve(e,t,n,s){return this._client.get(`/evals/${e}/runs/${t}/output_items/${n}`,s)}list(e,t,n={},s){return Je(n)?this.list(e,t,{},n):this._client.getAPIList(`/evals/${e}/runs/${t}/output_items`,Or,{query:n,...s})}}class Or extends mt{}Rr.OutputItemListResponsesPage=Or;class Cr extends dt{constructor(){super(...arguments),this.outputItems=new Rr(this._client)}create(e,t,n){return this._client.post(`/evals/${e}/runs`,{body:t,...n})}retrieve(e,t,n){return this._client.get(`/evals/${e}/runs/${t}`,n)}list(e,t={},n){return Je(t)?this.list(e,{},t):this._client.getAPIList(`/evals/${e}/runs`,kr,{query:t,...n})}del(e,t,n){return this._client.delete(`/evals/${e}/runs/${t}`,n)}cancel(e,t,n){return this._client.post(`/evals/${e}/runs/${t}`,n)}}class kr extends mt{}Cr.RunListResponsesPage=kr,Cr.OutputItems=Rr,Cr.OutputItemListResponsesPage=Or;class Tr extends dt{constructor(){super(...arguments),this.runs=new Cr(this._client)}create(e,t){return this._client.post("/evals",{body:e,...t})}retrieve(e,t){return this._client.get(`/evals/${e}`,t)}update(e,t,n){return this._client.post(`/evals/${e}`,{body:t,...n})}list(e={},t){return Je(e)?this.list({},e):this._client.getAPIList("/evals",$r,{query:e,...t})}del(e,t){return this._client.delete(`/evals/${e}`,t)}}class $r extends mt{}Tr.EvalListResponsesPage=$r,Tr.Runs=Cr,Tr.RunListResponsesPage=kr;class Nr extends dt{retrieve(e,t,n){return this._client.get(`/containers/${e}/files/${t}/content`,{...n,headers:{Accept:"application/binary",...n?.headers},__binaryResponse:!0})}}class Dr extends dt{constructor(){super(...arguments),this.content=new Nr(this._client)}create(e,t,n){return this._client.post(`/containers/${e}/files`,Ce({body:t,...n}))}retrieve(e,t,n){return this._client.get(`/containers/${e}/files/${t}`,n)}list(e,t={},n){return Je(t)?this.list(e,{},t):this._client.getAPIList(`/containers/${e}/files`,Mr,{query:t,...n})}del(e,t,n){return this._client.delete(`/containers/${e}/files/${t}`,{...n,headers:{Accept:"*/*",...n?.headers}})}}class Mr extends mt{}Dr.FileListResponsesPage=Mr,Dr.Content=Nr;class jr extends dt{constructor(){super(...arguments),this.files=new Dr(this._client)}create(e,t){return this._client.post("/containers",{body:e,...t})}retrieve(e,t){return this._client.get(`/containers/${e}`,t)}list(e={},t){return Je(e)?this.list({},e):this._client.getAPIList("/containers",Ur,{query:e,...t})}del(e,t){return this._client.delete(`/containers/${e}`,{...t,headers:{Accept:"*/*",...t?.headers}})}}class Ur extends mt{}jr.ContainerListResponsesPage=Ur,jr.Files=Dr,jr.FileListResponsesPage=Mr;class Lr extends Le{constructor({baseURL:e=nt("OPENAI_BASE_URL"),apiKey:t=nt("OPENAI_API_KEY"),organization:n=nt("OPENAI_ORG_ID")??null,project:s=nt("OPENAI_PROJECT_ID")??null,...r}={}){if(void 0===t)throw new Y("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");const o={apiKey:t,organization:n,project:s,...r,baseURL:e||"https://api.openai.com/v1"};if(!o.dangerouslyAllowBrowser&&"undefined"!=typeof window&&void 0!==window.document&&"undefined"!=typeof navigator)throw new Y("It looks like you're running in a browser-like environment.\n\nThis is disabled by default, as it risks exposing your secret API credentials to attackers.\nIf you understand the risks and have appropriate mitigations in place,\nyou can set the `dangerouslyAllowBrowser` option to `true`, e.g.,\n\nnew OpenAI({ apiKey, dangerouslyAllowBrowser: true });\n\nhttps://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety\n");super({baseURL:o.baseURL,timeout:o.timeout??6e5,httpAgent:o.httpAgent,maxRetries:o.maxRetries,fetch:o.fetch}),this.completions=new ht(this),this.chat=new vt(this),this.embeddings=new _t(this),this.files=new bt(this),this.images=new xt(this),this.audio=new Pt(this),this.moderations=new Rt(this),this.models=new Ot(this),this.fineTuning=new Ft(this),this.graders=new Jt(this),this.vectorStores=new Kt(this),this.beta=new tr(this),this.batches=new nr(this),this.uploads=new or(this),this.responses=new Sr(this),this.evals=new Tr(this),this.containers=new jr(this),this._options=o,this.apiKey=t,this.organization=n,this.project=s}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}stringifyQuery(e){return N(e,{arrayFormat:"brackets"})}}Er=Lr,Lr.OpenAI=Er,Lr.DEFAULT_TIMEOUT=6e5,Lr.OpenAIError=Y,Lr.APIError=Z,Lr.APIConnectionError=te,Lr.APIConnectionTimeoutError=ne,Lr.APIUserAbortError=ee,Lr.NotFoundError=ie,Lr.ConflictError=ae,Lr.RateLimitError=ce,Lr.BadRequestError=se,Lr.AuthenticationError=re,Lr.InternalServerError=ue,Lr.PermissionDeniedError=oe,Lr.UnprocessableEntityError=le,Lr.toFile=Se,Lr.fileFromPath=W,Lr.Completions=ht,Lr.Chat=vt,Lr.ChatCompletionsPage=gt,Lr.Embeddings=_t,Lr.Files=bt,Lr.FileObjectsPage=Et,Lr.Images=xt,Lr.Audio=Pt,Lr.Moderations=Rt,Lr.Models=Ot,Lr.ModelsPage=Ct,Lr.FineTuning=Ft,Lr.Graders=Jt,Lr.VectorStores=Kt,Lr.VectorStoresPage=zt,Lr.VectorStoreSearchResponsesPage=Qt,Lr.Beta=tr,Lr.Batches=nr,Lr.BatchesPage=sr,Lr.Uploads=or,Lr.Responses=Sr,Lr.Evals=Tr,Lr.EvalListResponsesPage=$r,Lr.Containers=jr,Lr.ContainerListResponsesPage=Ur;new Set(["/completions","/chat/completions","/embeddings","/audio/transcriptions","/audio/translations","/audio/speech","/images/generations","/images/edits"]);const qr=Lr;var Br=function(e,t,n,s){return new(n||(n=Promise))(function(r,o){function i(e){try{l(s.next(e))}catch(e){o(e)}}function a(e){try{l(s.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(i,a)}l((s=s.apply(e,t||[])).next())})},Fr=function(e){return this instanceof Fr?(this.v=e,this):new Fr(e)},Wr=function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e="function"==typeof __values?__values(e):e[Symbol.iterator](),t={},s("next"),s("throw"),s("return"),t[Symbol.asyncIterator]=function(){return this},t);function s(n){t[n]=e[n]&&function(t){return new Promise(function(s,r){(function(e,t,n,s){Promise.resolve(s).then(function(t){e({value:t,done:n})},t)})(s,r,(t=e[n](t)).done,t.value)})}}},Jr=function(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var s,r=n.apply(e,t||[]),o=[];return s={},i("next"),i("throw"),i("return"),s[Symbol.asyncIterator]=function(){return this},s;function i(e){r[e]&&(s[e]=function(t){return new Promise(function(n,s){o.push([e,t,n,s])>1||a(e,t)})})}function a(e,t){try{(n=r[e](t)).value instanceof Fr?Promise.resolve(n.value.v).then(l,c):u(o[0][2],n)}catch(e){u(o[0][3],e)}var n}function l(e){a("next",e)}function c(e){a("throw",e)}function u(e,t){e(t),o.shift(),o.length&&a(o[0][0],o[0][1])}};class Xr{constructor(e){this.config=e,this.client=new qr({apiKey:this.config.apiKey,dangerouslyAllowBrowser:!0})}generate(e){var t,n;return Br(this,void 0,void 0,function*(){try{const s=e.map(e=>({role:e.role,content:e.content})),r=yield this.client.chat.completions.create({model:this.config.model,messages:s,temperature:this.config.temperature||.7});return(null===(n=null===(t=r.choices[0])||void 0===t?void 0:t.message)||void 0===n?void 0:n.content)||""}catch(e){throw console.error("OpenAI API error:",e),this.handleAPIError(e),e}})}generateStream(e){var t,n,s;return Jr(this,arguments,function*(){var r,o,i,a;try{const d=e.map(e=>({role:e.role,content:e.content})),h=yield Fr(this.client.chat.completions.create({model:this.config.model,messages:d,temperature:this.config.temperature||.7,stream:!0}));try{for(var l,c=!0,u=Wr(h);!(r=(l=yield Fr(u.next())).done);){a=l.value,c=!1;try{const e=a,r=(null===(n=null===(t=e.choices[0])||void 0===t?void 0:t.delta)||void 0===n?void 0:n.content)||"",o="stop"===(null===(s=e.choices[0])||void 0===s?void 0:s.finish_reason);yield yield Fr({content:r,isComplete:o})}finally{c=!0}}}catch(e){o={error:e}}finally{try{c||r||!(i=u.return)||(yield Fr(i.call(u)))}finally{if(o)throw o.error}}}catch(e){console.error("OpenAI streaming error:",e),this.handleAPIError(e)}})}handleAPIError(e){throw 401===e.status?new s({type:n.AUTHENTICATION,message:"Invalid OpenAI API key. Please check your API key in the extension options."}):429===e.status?new s({type:n.QUOTA_EXCEEDED,message:"OpenAI API rate limit exceeded. Please try again later."}):404===e.status?new s({type:n.MODEL_ACCESS,message:`The requested model "${this.config.model}" is not available with your API key.`}):new s({type:n.SERVER,message:`Error calling OpenAI API: ${e.message||"Unknown error"}`,details:e})}}var Vr=function(e,t,n,s){return new(n||(n=Promise))(function(r,o){function i(e){try{l(s.next(e))}catch(e){o(e)}}function a(e){try{l(s.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(i,a)}l((s=s.apply(e,t||[])).next())})},Gr=function(e){return this instanceof Gr?(this.v=e,this):new Gr(e)},Hr=function(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var s,r=n.apply(e,t||[]),o=[];return s={},i("next"),i("throw"),i("return"),s[Symbol.asyncIterator]=function(){return this},s;function i(e){r[e]&&(s[e]=function(t){return new Promise(function(n,s){o.push([e,t,n,s])>1||a(e,t)})})}function a(e,t){try{(n=r[e](t)).value instanceof Gr?Promise.resolve(n.value.v).then(l,c):u(o[0][2],n)}catch(e){u(o[0][3],e)}var n}function l(e){a("next",e)}function c(e){a("throw",e)}function u(e,t){e(t),o.shift(),o.length&&a(o[0][0],o[0][1])}};class Kr{constructor(e){this.baseUrl="https://api.deepseek.com/v1",this.config=e}generate(e){var t,r;return Vr(this,void 0,void 0,function*(){try{const n=e.map(e=>({role:e.role,content:e.content})),s=yield fetch(`${this.baseUrl}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify({model:this.config.model,messages:n,temperature:this.config.temperature||.7})});s.ok||(yield this.handleResponseError(s));const o=yield s.json();return(null===(r=null===(t=o.choices[0])||void 0===t?void 0:t.message)||void 0===r?void 0:r.content)||""}catch(e){if(console.error("DeepSeek API error:",e),e instanceof s)throw e;throw new s({type:n.SERVER,message:`Error calling DeepSeek API: ${e.message||"Unknown error"}`,details:e})}})}generateStream(e){var t,r,o;return Hr(this,arguments,function*(){try{const i=e.map(e=>({role:e.role,content:e.content})),a=yield Gr(fetch(`${this.baseUrl}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify({model:this.config.model,messages:i,temperature:this.config.temperature||.7,stream:!0})}));if(a.ok||(yield Gr(this.handleResponseError(a))),!a.body)throw new s({type:n.SERVER,message:"DeepSeek API returned empty response stream"});const l=a.body.getReader(),c=new TextDecoder("utf-8");let u="";for(;;){const{done:e,value:n}=yield Gr(l.read());if(e)break;u+=c.decode(n,{stream:!0});const s=u.split("\n");u=s.pop()||"";for(const e of s)if(e.startsWith("data: ")){const n=e.slice(6);if("[DONE]"===n)return yield yield Gr({content:"",isComplete:!0}),yield Gr(void 0);try{const e=JSON.parse(n),s=(null===(r=null===(t=e.choices[0])||void 0===t?void 0:t.delta)||void 0===r?void 0:r.content)||"",i="stop"===(null===(o=e.choices[0])||void 0===o?void 0:o.finish_reason);if(yield yield Gr({content:s,isComplete:i}),i)return yield Gr(void 0)}catch(e){console.error("Error parsing SSE data:",e)}}}}catch(e){if(console.error("DeepSeek streaming error:",e),e instanceof s)throw e;throw new s({type:n.SERVER,message:`Error streaming from DeepSeek API: ${e.message||"Unknown error"}`,details:e})}})}handleResponseError(e){var t;return Vr(this,void 0,void 0,function*(){const r=yield e.json().catch(()=>({}));throw 401===e.status?new s({type:n.AUTHENTICATION,message:"Invalid DeepSeek API key. Please check your API key in the extension options."}):429===e.status?new s({type:n.QUOTA_EXCEEDED,message:"DeepSeek API rate limit exceeded. Please try again later."}):404===e.status?new s({type:n.MODEL_ACCESS,message:`The requested model "${this.config.model}" is not available with your API key.`}):new s({type:n.SERVER,message:`DeepSeek API error (${e.status}): ${(null===(t=r.error)||void 0===t?void 0:t.message)||"Unknown error"}`,details:r})})}}var zr=function(e,t,n,s){return new(n||(n=Promise))(function(r,o){function i(e){try{l(s.next(e))}catch(e){o(e)}}function a(e){try{l(s.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(i,a)}l((s=s.apply(e,t||[])).next())})},Qr=function(e){return this instanceof Qr?(this.v=e,this):new Qr(e)},Yr=function(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var s,r=n.apply(e,t||[]),o=[];return s={},i("next"),i("throw"),i("return"),s[Symbol.asyncIterator]=function(){return this},s;function i(e){r[e]&&(s[e]=function(t){return new Promise(function(n,s){o.push([e,t,n,s])>1||a(e,t)})})}function a(e,t){try{(n=r[e](t)).value instanceof Qr?Promise.resolve(n.value.v).then(l,c):u(o[0][2],n)}catch(e){u(o[0][3],e)}var n}function l(e){a("next",e)}function c(e){a("throw",e)}function u(e,t){e(t),o.shift(),o.length&&a(o[0][0],o[0][1])}};class Zr{constructor(e){this.baseUrl="https://api.anthropic.com/v1",this.config=e}generate(e){var t,r;return zr(this,void 0,void 0,function*(){try{const{systemMessage:n,formattedMessages:s}=this.formatMessages(e),o={model:this.config.model,messages:s,temperature:this.config.temperature||.7,max_tokens:4096};n&&(o.system=n);const i=yield fetch(`${this.baseUrl}/messages`,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":this.config.apiKey,"anthropic-version":"2023-06-01"},body:JSON.stringify(o)});i.ok||(yield this.handleResponseError(i));const a=yield i.json();return a.content&&Array.isArray(a.content)?a.content.map(e=>e.text||"").join(""):(null===(r=null===(t=a.content)||void 0===t?void 0:t[0])||void 0===r?void 0:r.text)||""}catch(e){if(console.error("Anthropic API error:",e),e instanceof s)throw e;throw new s({type:n.SERVER,message:`Error calling Anthropic API: ${e.message||"Unknown error"}`,details:e})}})}generateStream(e){var t,r;return Yr(this,arguments,function*(){try{const{systemMessage:o,formattedMessages:i}=this.formatMessages(e),a={model:this.config.model,messages:i,temperature:this.config.temperature||.7,max_tokens:4096,stream:!0};o&&(a.system=o);const l=yield Qr(fetch(`${this.baseUrl}/messages`,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":this.config.apiKey,"anthropic-version":"2023-06-01"},body:JSON.stringify(a)}));if(l.ok||(yield Qr(this.handleResponseError(l))),!l.body)throw new s({type:n.SERVER,message:"Anthropic API returned empty response stream"});const c=l.body.getReader(),u=new TextDecoder("utf-8");let d="";for(;;){const{done:e,value:n}=yield Qr(c.read());if(e)break;d+=u.decode(n,{stream:!0});const s=d.split("\n");d=s.pop()||"";for(const e of s){const n=e.trim();if((n.startsWith("event: ")||n.startsWith("data: "))&&n.startsWith("data: ")){const e=n.slice(6);if("[DONE]"===e)return yield yield Qr({content:"",isComplete:!0}),yield Qr(void 0);try{const n=JSON.parse(e);if("message_start"===n.type)continue;if("content_block_start"===n.type)continue;if("content_block_delta"===n.type){const e=(null===(t=n.delta)||void 0===t?void 0:t.text)||"";e&&(yield yield Qr({content:e,isComplete:!1}))}else{if("content_block_stop"===n.type)continue;if("message_delta"===n.type){const e=null===(r=n.delta)||void 0===r?void 0:r.stop_reason;if("end_turn"===e||"refusal"===e)return yield yield Qr({content:"",isComplete:!0}),yield Qr(void 0)}else if("message_stop"===n.type)return yield yield Qr({content:"",isComplete:!0}),yield Qr(void 0)}}catch(e){console.error("Error parsing SSE data:",e)}}}}}catch(e){if(console.error("Anthropic streaming error:",e),e instanceof s)throw e;throw new s({type:n.SERVER,message:`Error streaming from Anthropic API: ${e.message||"Unknown error"}`,details:e})}})}formatMessages(e){let t;const n=[];for(const s of e)"system"===s.role?t=s.content:n.push({role:this.mapRole(s.role),content:s.content});return{systemMessage:t,formattedMessages:n}}mapRole(e){return{system:"system",user:"user",assistant:"assistant"}[e]||e}handleResponseError(e){var t,r,o,i,a;return zr(this,void 0,void 0,function*(){const l=yield e.json().catch(()=>({}));if(console.error(`Anthropic API Error for model ${this.config.model}:`,{status:e.status,statusText:e.statusText,headers:Object.fromEntries(e.headers.entries()),errorData:l,model:this.config.model}),401===e.status)throw new s({type:n.AUTHENTICATION,message:"Invalid Anthropic API key. Please check your API key."});if(429===e.status)throw new s({type:n.QUOTA_EXCEEDED,message:"Anthropic API rate limit exceeded. Please try again later."});if(404===e.status)throw new s({type:n.MODEL_ACCESS,message:`The requested model "${this.config.model}" is not available with your API key.`});if(400===e.status&&"invalid_request_error"===(null===(t=l.error)||void 0===t?void 0:t.type)){if(null===(o=null===(r=l.error)||void 0===r?void 0:r.message)||void 0===o?void 0:o.includes("model"))throw new s({type:n.MODEL_ACCESS,message:`The model "${this.config.model}" is not available. Please try Claude 3.5 Sonnet instead.`});throw new s({type:n.SERVER,message:`Invalid request: ${(null===(i=l.error)||void 0===i?void 0:i.message)||"Unknown error"}`,details:l})}throw new s({type:n.SERVER,message:`Anthropic API error (${e.status}): ${(null===(a=l.error)||void 0===a?void 0:a.message)||"Unknown error"}`,details:l})})}}var eo=function(e,t,n,s){return new(n||(n=Promise))(function(r,o){function i(e){try{l(s.next(e))}catch(e){o(e)}}function a(e){try{l(s.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(i,a)}l((s=s.apply(e,t||[])).next())})},to=function(e){return this instanceof to?(this.v=e,this):new to(e)},no=function(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var s,r=n.apply(e,t||[]),o=[];return s={},i("next"),i("throw"),i("return"),s[Symbol.asyncIterator]=function(){return this},s;function i(e){r[e]&&(s[e]=function(t){return new Promise(function(n,s){o.push([e,t,n,s])>1||a(e,t)})})}function a(e,t){try{(n=r[e](t)).value instanceof to?Promise.resolve(n.value.v).then(l,c):u(o[0][2],n)}catch(e){u(o[0][3],e)}var n}function l(e){a("next",e)}function c(e){a("throw",e)}function u(e,t){e(t),o.shift(),o.length&&a(o[0][0],o[0][1])}};class so{constructor(e){this.baseUrl="https://openrouter.ai/api/v1",this.config=e}generate(e){var t,r;return eo(this,void 0,void 0,function*(){try{const n=e.map(e=>({role:e.role,content:e.content})),s=yield fetch(`${this.baseUrl}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify({model:this.config.model,messages:n,temperature:this.config.temperature||.7})});s.ok||(yield this.handleResponseError(s));const o=yield s.json();return(null===(r=null===(t=o.choices[0])||void 0===t?void 0:t.message)||void 0===r?void 0:r.content)||""}catch(e){if(console.error("OpenRouter API error:",e),e instanceof s)throw e;throw new s({type:n.SERVER,message:`Error calling OpenRouter API: ${e.message||"Unknown error"}`,details:e})}})}generateStream(e){var t,r,o;return no(this,arguments,function*(){try{const i=e.map(e=>({role:e.role,content:e.content})),a=yield to(fetch(`${this.baseUrl}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify({model:this.config.model,messages:i,temperature:this.config.temperature||.7,stream:!0})}));if(a.ok||(yield to(this.handleResponseError(a))),!a.body)throw new s({type:n.SERVER,message:"OpenRouter API returned empty response stream"});const l=a.body.getReader(),c=new TextDecoder("utf-8");let u="";for(;;){const{done:e,value:n}=yield to(l.read());if(e)break;u+=c.decode(n,{stream:!0});const s=u.split("\n");u=s.pop()||"";for(const e of s)if(e.startsWith("data: ")){const n=e.slice(6);if("[DONE]"===n)return yield yield to({content:"",isComplete:!0}),yield to(void 0);try{const e=JSON.parse(n),s=(null===(r=null===(t=e.choices[0])||void 0===t?void 0:t.delta)||void 0===r?void 0:r.content)||"",i="stop"===(null===(o=e.choices[0])||void 0===o?void 0:o.finish_reason);if(yield yield to({content:s,isComplete:i}),i)return yield to(void 0)}catch(e){console.error("Error parsing SSE data:",e)}}}}catch(e){if(console.error("OpenRouter streaming error:",e),e instanceof s)throw e;throw new s({type:n.SERVER,message:`Error streaming from OpenRouter API: ${e.message||"Unknown error"}`,details:e})}})}handleResponseError(e){var t,r;return eo(this,void 0,void 0,function*(){const o=yield e.json().catch(()=>({}));throw console.error(`OpenRouter API Error for model ${this.config.model}:`,{status:e.status,statusText:e.statusText,errorData:o,model:this.config.model}),401===e.status?new s({type:n.AUTHENTICATION,message:"Invalid OpenRouter API key. Please check your API key in the extension options."}):429===e.status?new s({type:n.QUOTA_EXCEEDED,message:"OpenRouter API rate limit exceeded. Please try again later."}):404===e.status?new s({type:n.MODEL_ACCESS,message:`The requested model "${this.config.model}" is not available with your API key.`}):400===e.status?new s({type:n.MODEL_ACCESS,message:`Bad request for model "${this.config.model}". Model may not be available or properly configured: ${(null===(t=o.error)||void 0===t?void 0:t.message)||"Unknown error"}`,details:o}):new s({type:n.SERVER,message:`OpenRouter API error (${e.status}): ${(null===(r=o.error)||void 0===r?void 0:r.message)||"Unknown error"}`,details:o})})}}var ro,oo=function(e,t,n,s){return new(n||(n=Promise))(function(r,o){function i(e){try{l(s.next(e))}catch(e){o(e)}}function a(e){try{l(s.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(i,a)}l((s=s.apply(e,t||[])).next())})},io=function(e){return this instanceof io?(this.v=e,this):new io(e)},ao=function(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var s,r=n.apply(e,t||[]),o=[];return s={},i("next"),i("throw"),i("return"),s[Symbol.asyncIterator]=function(){return this},s;function i(e){r[e]&&(s[e]=function(t){return new Promise(function(n,s){o.push([e,t,n,s])>1||a(e,t)})})}function a(e,t){try{(n=r[e](t)).value instanceof io?Promise.resolve(n.value.v).then(l,c):u(o[0][2],n)}catch(e){u(o[0][3],e)}var n}function l(e){a("next",e)}function c(e){a("throw",e)}function u(e,t){e(t),o.shift(),o.length&&a(o[0][0],o[0][1])}};class lo{constructor(e){this.baseUrl="https://generativelanguage.googleapis.com/v1beta",this.config=e}generate(e){return oo(this,void 0,void 0,function*(){try{const t={contents:this.formatMessages(e),generationConfig:{temperature:this.config.temperature||.7,maxOutputTokens:4096}},n=yield fetch(`${this.baseUrl}/models/${this.config.model}:generateContent?key=${this.config.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});n.ok||(yield this.handleResponseError(n));const s=yield n.json();if(s.candidates&&s.candidates.length>0){const e=s.candidates[0];if(e.content&&e.content.parts)return e.content.parts.map(e=>e.text||"").join("")}return""}catch(e){if(console.error("Gemini API error:",e),e instanceof s)throw e;throw new s({type:n.SERVER,message:`Error calling Gemini API: ${e.message||"Unknown error"}`,details:e})}})}generateStream(e){return ao(this,arguments,function*(){try{const t={contents:this.formatMessages(e),generationConfig:{temperature:this.config.temperature||.7,maxOutputTokens:4096}},r=yield io(fetch(`${this.baseUrl}/models/${this.config.model}:streamGenerateContent?key=${this.config.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}));if(r.ok||(yield io(this.handleResponseError(r))),!r.body)throw new s({type:n.SERVER,message:"Gemini API returned empty response stream"});const o=r.body.getReader(),i=new TextDecoder("utf-8");let a="";for(;;){const{done:e,value:t}=yield io(o.read());if(e)break;a+=i.decode(t,{stream:!0});const n=a.split("\n");a=n.pop()||"";for(const e of n){const t=e.trim();if(t.startsWith("data: ")){const e=t.slice(6);if("[DONE]"===e)return yield yield io({content:"",isComplete:!0}),yield io(void 0);try{const t=JSON.parse(e);if(t.candidates&&t.candidates.length>0){const e=t.candidates[0];if(e.content&&e.content.parts){const t=e.content.parts.map(e=>e.text||"").join("");t&&(yield yield io({content:t,isComplete:!1}))}if(e.finishReason)return yield yield io({content:"",isComplete:!0}),yield io(void 0)}}catch(e){console.error("Error parsing Gemini SSE data:",e)}}}}yield yield io({content:"",isComplete:!0})}catch(e){if(console.error("Gemini streaming error:",e),e instanceof s)throw e;throw new s({type:n.SERVER,message:`Error streaming from Gemini API: ${e.message||"Unknown error"}`,details:e})}})}formatMessages(e){const t=[];let n="";for(const s of e)"system"===s.role?n=s.content:t.push({role:this.mapRole(s.role),parts:[{text:s.content}]});return n&&t.length>0&&(t[0]={role:"user",parts:[{text:`${n}\n\n${t[0].parts[0].text}`}]}),t}mapRole(e){return{user:"user",assistant:"model"}[e]||"user"}handleResponseError(e){var t;return oo(this,void 0,void 0,function*(){const r=yield e.json().catch(()=>({}));throw 401===e.status||403===e.status?new s({type:n.AUTHENTICATION,message:"Invalid Gemini API key. Please check your API key."}):429===e.status?new s({type:n.QUOTA_EXCEEDED,message:"Gemini API rate limit exceeded. Please try again later."}):404===e.status?new s({type:n.MODEL_ACCESS,message:`The requested model "${this.config.model}" is not available.`}):new s({type:n.SERVER,message:`Gemini API error (${e.status}): ${(null===(t=r.error)||void 0===t?void 0:t.message)||"Unknown error"}`,details:r})})}}!function(e){e.OPENAI="openai",e.DEEPSEEK="deepseek",e.ANTHROPIC="anthropic",e.MISTRAL="mistral",e.OPENROUTER="openrouter",e.GEMINI="gemini"}(ro||(ro={}));const co=[{id:"o3-mini",name:"OpenAI o3-mini",provider:ro.OPENAI,description:"Latest reasoning model optimized for coding, math, and science"},{id:"o3-mini-high",name:"OpenAI o3-mini (High)",provider:ro.OPENAI,description:"Higher-intelligence version of o3-mini with superior reasoning"},{id:"gpt-4o",name:"GPT-4o",provider:ro.OPENAI,description:"Most capable GPT-4 model with multimodal capabilities"},{id:"gpt-4o-mini",name:"GPT-4o Mini",provider:ro.OPENAI,description:"Smaller, faster, and cheaper GPT-4 model"},{id:"deepseek-reasoner",name:"DeepSeek R1",provider:ro.DEEPSEEK,description:"Latest reasoning model with enhanced problem-solving capabilities"},{id:"deepseek-chat",name:"DeepSeek V3",provider:ro.DEEPSEEK,description:"General chat model with strong coding and reasoning abilities"},{id:"claude-3-5-sonnet-20241022",name:"Claude 3.5 Sonnet",provider:ro.ANTHROPIC,description:"Excellent Claude model for complex reasoning and coding tasks"},{id:"claude-3-7-sonnet-20250219",name:"Claude 3.7 Sonnet (New)",provider:ro.ANTHROPIC,description:"Latest Claude 3.7 model with enhanced capabilities"},{id:"claude-3-5-haiku-20241022",name:"Claude 3.5 Haiku",provider:ro.ANTHROPIC,description:"Fastest Claude model for quick tasks and real-time responses"},{id:"claude-opus-4-20250514",name:"Claude Opus 4 (Preview)",provider:ro.ANTHROPIC,description:"Most intelligent Claude model for the most complex tasks (limited availability)"},{id:"claude-sonnet-4-20250514",name:"Claude Sonnet 4 (Preview)",provider:ro.ANTHROPIC,description:"Advanced Claude model balancing intelligence and speed (limited availability)"},{id:"mistral-large-latest",name:"Mistral Large 2.1",provider:ro.MISTRAL,description:"Latest flagship model with enhanced reasoning (Nov 2024)"},{id:"pixtral-large-latest",name:"Pixtral Large",provider:ro.MISTRAL,description:"124B multimodal, 69.4% MathVista, best open-weights vision model"},{id:"gemini-2.5-pro",name:"Gemini 2.5 Pro",provider:ro.GEMINI,description:"Advanced reasoning, multimodal understanding, and complex programming"},{id:"gemini-2.5-flash",name:"Gemini 2.5 Flash",provider:ro.GEMINI,description:"Cost-effective, full-featured with adaptive reasoning"},{id:"gemini-2.0-flash",name:"Gemini 2.0 Flash",provider:ro.GEMINI,description:"Next-generation features with enhanced capabilities and 1M token context"},{id:"gemini-1.5-pro",name:"Gemini 1.5 Pro",provider:ro.GEMINI,description:"Multimodal model optimized for reasoning tasks (deprecated Sept 2025)"},{id:"meta-llama/llama-4-maverick",name:"Llama 4 Maverick",provider:ro.OPENROUTER,description:"MoE 400B (17B active), 256K context, sliding window (Apr 2025)"},{id:"openai/o3-mini",name:"OpenAI o3-mini (OR)",provider:ro.OPENROUTER,description:"OpenAI o3-mini via OpenRouter"},{id:"google/gemini-2.5-pro",name:"Gemini 2.5 Pro (OR)",provider:ro.OPENROUTER,description:"Google's latest multimodal AI model via OpenRouter"},{id:"google/gemini-2.0-flash",name:"Gemini 2.0 Flash (OR)",provider:ro.OPENROUTER,description:"Gemini 2.0 Flash via OpenRouter"},{id:"anthropic/claude-3.5-sonnet",name:"Claude 3.5 Sonnet (OR)",provider:ro.OPENROUTER,description:"Claude 3.5 Sonnet via OpenRouter"},{id:"anthropic/claude-opus-4",name:"Claude Opus 4 (OR)",provider:ro.OPENROUTER,description:"Claude Opus 4 via OpenRouter"},{id:"anthropic/claude-sonnet-4",name:"Claude Sonnet 4 (OR)",provider:ro.OPENROUTER,description:"Claude Sonnet 4 via OpenRouter"},{id:"qwen/qwen-3-235b-a22b-instruct",name:"Qwen3 235B",provider:ro.OPENROUTER,description:"Qwen3 flagship MoE, 256K context, updated July 2025"},{id:"deepseek/deepseek-r1-0528",name:"DeepSeek R1-0528 (OR)",provider:ro.OPENROUTER,description:"Latest DeepSeek reasoning via OpenRouter"},{id:"x-ai/grok-4",name:"Grok-4",provider:ro.OPENROUTER,description:"Most intelligent xAI model with tool use & search (July 2025)"},{id:"moonshot/kimi-k2",name:"Kimi K2",provider:ro.OPENROUTER,description:"1T params MoE, 32B active, agentic AI with MCP support (July 2025)"}];function uo(e){return co.find(t=>t.id===e)}class ho{static createModel(e){switch(e.provider){case ro.OPENAI:return new Xr(e);case ro.DEEPSEEK:return new Kr(e);case ro.MISTRAL:return new w(e);case ro.ANTHROPIC:return new Zr(e);case ro.OPENROUTER:return new so(e);case ro.GEMINI:return new lo(e);default:throw new s({type:n.CONFIGURATION,message:`Unsupported model provider: ${e.provider}`})}}static createModelFromId(e,t,r){const o=uo(e);if(!o)throw new s({type:n.CONFIGURATION,message:`Unknown model ID: ${e}`});if(!t||""===t.trim())throw new s({type:n.CONFIGURATION,message:`API key is required for ${o.provider} provider`});const i={provider:o.provider,model:e,apiKey:t,temperature:r};return this.createModel(i)}}const po=' You are an expert AI agent that looks at a simplified jupyter notebook and a user request, and provides a list of cell IDs that are essential for addressing the request.\nThe notebook code is signicantly simplified. Some of the simplifications are:\n- Any information within paranthesis is removed (parameters, etc.)\n- Function implementations are removed\nRespond ONLY with a JSON array of cell IDs that are essential for addressing the request. For example, if the request is related to an AI model, the response should include the cell IDs for the model implementation, training, and evaluation.\n\nExample:\n[\n    "cell-1",\n    "cell-2"\n]';var fo=function(e,t,n,s){return new(n||(n=Promise))(function(r,o){function i(e){try{l(s.next(e))}catch(e){o(e)}}function a(e){try{l(s.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(i,a)}l((s=s.apply(e,t||[])).next())})},mo=function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e="function"==typeof __values?__values(e):e[Symbol.iterator](),t={},s("next"),s("throw"),s("return"),t[Symbol.asyncIterator]=function(){return this},t);function s(n){t[n]=e[n]&&function(t){return new Promise(function(s,r){(function(e,t,n,s){Promise.resolve(s).then(function(t){e({value:t,done:n})},t)})(s,r,(t=e[n](t)).done,t.value)})}}};function yo(e){return fo(this,void 0,void 0,function*(){const t={[ro.OPENAI]:"openai_api_key",[ro.DEEPSEEK]:"deepseek_api_key",[ro.ANTHROPIC]:"anthropic_api_key",[ro.MISTRAL]:"mistral_api_key",[ro.OPENROUTER]:"openrouter_api_key",[ro.GEMINI]:"gemini_api_key"}[e];if(!t)throw new s({type:n.CONFIGURATION,message:`No storage key mapping found for provider: ${e}`});const r=(yield chrome.storage.local.get(t))[t];if(console.log(`Retrieving API key for ${e} with storage key ${t}:`,r?`[Key present: ${r.substring(0,10)}...]`:"[No key found]"),!r)throw new s({type:n.CONFIGURATION,message:`API key for ${e} is not configured. Please set it in the extension options.`});return r})}let go;const wo=[],vo=[],_o=[];function bo(e,r,o="gpt-4o-mini"){var a;return fo(this,void 0,void 0,function*(){try{!function(e){const n=go||new t;go=n,n.updateState(e)}(r),function(e){p.buffer="",p.textContent="",p.fullResponse="",p.appliedOperations=new Map,p.currentOperations=new Map,p.isCodeBlock=!1,p.originalContent=e}(r);let i=go.getLastState([],!1);const{allow_reduce_content:l}=yield chrome.storage.local.get("allow_reduce_content"),c=l&&i.length>1e5;if(console.log("Should reduce content:",c),c){const t=yield function(e,t="gpt-4o-mini"){return fo(this,void 0,void 0,function*(){try{const r=go.getLastState([],!0),o=[{role:"system",content:po},{role:"user",content:`Current notebook state: ${r}\nPrompt: ${e}`}],i=yield function(e,t){return fo(this,void 0,void 0,function*(){const r=uo(t);if(!r)throw new s({type:n.CONFIGURATION,message:`Unknown model ID: ${t}. Please select a valid model in the settings.`});const o=r.provider,i=yield yo(o),a=ho.createModelFromId(t,i,.2);try{return yield a.generate(e)}catch(e){throw console.error(`${o} API error:`,e),e}})}(o,t);try{const e=JSON.parse(i);if(console.log("Required cell IDs:",e),Array.isArray(e)&&e.length>0)return e}catch(e){console.error("Error parsing cell IDs from response:",e);const t=/(cell-\S+)/g,n=i.match(t);if(n&&n.length>0)return n}}catch(e){console.error("Error getting required cell IDs:",e)}return[]})}(e,o),r=/(cell-\S+)/g;null===(a=e.match(r))||void 0===a||a.forEach(e=>{t.includes(e)||t.push(e)}),i=go.getLastState(t,!0)}vo.length>3&&vo.shift(),vo.push(e);const u=[];u.push({role:"system",content:'You are ColabAI, an exceptional senior data scientist and python developer with vast knowledge across multiple fields, frameworks, and best practices. Your goal is to help users in creating, optimizing, and managing their Google Colab Notebooks. You can perform the following operations on notebook cells.\n\n<available_operations>\n  <operation description="Create a new cell">\n    @CREATE[type=markdown|code, position=top|bottom|after:cell-{cellId}|before:cell-{cellId}]\n    content\n    @END\n  </operation>\n\n  <operation description="Delete a cell">\n    @DELETE[cell-{cellId}]\n  </operation>\n\n  <operation description="Edit a cell, the content of the cell will be completely replaced">\n    @EDIT[cell-{cellId}]\n    new content\n    @END\n  </operation>\n\n  These are the ONLY operations you can perform on notebook cells. Make sure to follow the correct syntax and structure for each operation.\n</available_operations>\n\n<cell_types>\n  <markdown_cell>\n    - Use formatting: bold, italic, lists, tables\n    - Add context before code cells\n    - Include LaTeX for math equations\n    - Embed diagrams/charts where needed\n  </markdown_cell>\n\n  <code_cell>\n    - Break into logical chunks\n    - Add helpful comments\n    - Use descriptive names\n    - Group related code together\n  </code_cell>\n</cell_types>\n\n<response_format>\n  - All operations must be between @START_CODE and @END_CODE (Don\'t forget the @END_CODE at the end of the operations)\n  - You can write in normal text before and after these markers, explaining what you are doing or replying to the user\n  - Be very brief and clear in your responses before and after the markers. You can write in markdown format here\n  - Always aim to improve the structure of the notebook, removing unneeded cells and reordering content to be logical and coherent\n</response_format>\n\n<examples>\n<example>\n  <user_request>\n    This is the current notebook state for reference: <notebook_state>[{"id": "cell-N8PmTh-BqoUv", "type": "code", "content": ""}]</notebook_state>. I want to learn logistic regression by implementing a model that can determine students\' chance of admission based on their results on two exams. I have historical data from previous applicants and their admission decision. Do logistic regression from scratch.\n  </user_request>\n\n  <your_response>\n    Sure thing, here\'s a step-by-step guide through implementing logistic regression from scratch.\n\n    @START_CODE\n\n    @DELETE[cell-N8PmTh-BqoUv]\n\n    @CREATE[type=markdown, position=top]\n    # Student Admission Predictor\n    @END\n\n    @CREATE[type=markdown, position=bottom]\n    ## Data Analysis\n    let\'s start by examining the data.\n    @END\n\n    @CREATE[type=code, position=bottom]\n    import numpy as np\n    import pandas as pd\n    import matplotlib.pyplot as plt\n    import os\n    %matplotlib inline\n    @END\n\n   @CREATE[type=code, position=bottom]\n    path = "path/to/data"\n    data = pd.read_csv(path, header=None, names=[\'Exam 1\', \'Exam 2\', \'Admitted\']) // Ensure that the column names match\n    data.head()\n    @END\n\n    @CREATE[type=markdown, position=bottom]\n    Let\'s create a scatter plot of the two scores and use color coding to visualize if the example is positive (admitted) or negative (not admitted).\n    @END\n\n    [...]\n\n    @END_CODE\n    \n    This will help you get started with your project. Let me know if you need any more help!\n  </your_response>\n</example>\n\n<example>\n  <user_request>\n    This is the current notebook state for reference: <notebook_state>[{"id":"cell-c8Tf-I25qLtf","type":"markdown","content":"**COE-476 HW3: Classification**\n---\n\n"},{"id":"cell-zcZYJWyMJ4uF","type":"markdown","content":"Q.1. Binary Classification: <br>"},{"id":"cell-uPYNAq2NJ9bJ","type":"markdown","content":"[Q1.1] The images.zip dataset folder contains a binary and a multiclass problems. In this question you are required to read the images in the binary folder to a numpy array X and the labels "folder names" into a numpy array y. Resize all images to 224x224"},{"id":"cell-uK5g0RFjOnex","type":"code","content":"from google.colab import drive\ndrive.mount(\'/content/drive\')"},{"id":"cell-2mm3CI1TWF1D","type":"code","content":"import os\nimport numpy as np\nfrom PIL import Image\n\nbinary_dir = \'/content/drive/MyDrive/Fall 2024/Neural Networks/HW3/Dataset/Binary\'"},{"id":"cell-ByNpG_bWMe-U","type":"markdown","content":"[Q1.2.] Plot the distribution of each class."},{"id":"cell-qIMckEY0WKsm","type":"code","content":""},{"id":"cell-fJxVmV-cMxre","type":"markdown","content":"[Q1.3.] Fit a simple Feed-forward network to perform the classification for you. use the following architecture and replace the missing parameters with appropriate values. Follow a 80-20 train-test split, ensure that your images are normalized between 0-1 and use a batch_size of 2, train for 5 epochs only."},{"id":"cell-9TBiQratWMEz","type":"code","content":""},{"id":"cell-Q-tqp2DligjS","type":"markdown","content":"[Q.1.4.] Print out the classification report for the results obtained"},{"id":"cell-f8cP1l0JXM12","type":"code","content":""}]</notebook_state>. Solve the following questions.\n  </user_request>\n\n  <your_response>\n    I\'ll help you solve these questions step by step. Let\'s start with Q1.1 to read and prepare the image data.\n\n    @START_CODE\n\n    @EDIT[cell-2mm3CI1TWF1D]\n    import os\n    import numpy as np\n    from PIL import Image\n\n    # Path to binary dataset\n    binary_dir = \'/content/drive/MyDrive/Fall 2024/Neural Networks/HW3/Dataset/Binary\'\n\n    # Initialize lists to store images and labels\n    X = []\n    y = []\n\n    # Get class names (folder names)\n    classes = os.listdir(binary_dir)\n\n    # Read images from each class\n    for class_idx, class_name in enumerate(classes):\n        class_path = os.path.join(binary_dir, class_name)\n        \n        # Read all images in the class folder\n        for img_name in os.listdir(class_path):\n            img_path = os.path.join(class_path, img_name)\n            \n            # Open and resize image\n            img = Image.open(img_path)\n            img = img.resize((224, 224))\n            \n            # Convert to numpy array\n            img_array = np.array(img)\n            \n            # Add to lists\n            X.append(img_array)\n            y.append(class_idx)\n\n    # Convert lists to numpy arrays\n    X = np.array(X)\n    y = np.array(y)\n\n    print("Data shape:", X.shape)\n    print("Labels shape:", y.shape)\n    print("Classes:", classes)\n    @END\n\n    @EDIT[cell-qIMckEY0WKsm]\n    import matplotlib.pyplot as plt\n\n    # Count samples in each class\n    unique_classes, counts = np.unique(y, return_counts=True)\n\n    # Create bar plot\n    plt.figure(figsize=(8, 6))\n    plt.bar(classes, counts)\n    plt.title(\'Distribution of Classes\')\n    plt.xlabel(\'Class\')\n    plt.ylabel(\'Number of Samples\')\n    plt.xticks(rotation=45)\n    plt.tight_layout()\n    plt.show()\n\n    print("Class distribution:")\n    for class_name, count in zip(classes, counts):\n        print(f"{class_name}: {count} samples")\n    @END\n\n    @EDIT[cell-9TBiQratWMEz]\n    import tensorflow as tf\n    from sklearn.model_selection import train_test_split\n    from tensorflow.keras import layers, models\n\n    # Normalize the data\n    X = X.astype(\'float32\') / 255.0\n\n    # Split the data\n    X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)\n\n    # Build the model\n    model = models.Sequential([\n        layers.Flatten(input_shape=(224, 224, 3)),\n        layers.Dense(128, activation=\'relu\'),\n        layers.Dropout(0.3),\n        layers.Dense(64, activation=\'relu\'),\n        layers.Dropout(0.2),\n        layers.Dense(1, activation=\'sigmoid\')\n    ])\n\n    # Compile the model\n    model.compile(optimizer=\'adam\',\n                  loss=\'binary_crossentropy\',\n                  metrics=[\'accuracy\'])\n\n    # Train the model\n    history = model.fit(X_train, y_train,\n                        batch_size=2,\n                        epochs=5,\n                        validation_data=(X_test, y_test))\n    @END\n\n    @EDIT[cell-f8cP1l0JXM12]\n    from sklearn.metrics import classification_report\n\n    # Get predictions\n    y_pred = model.predict(X_test)\n    y_pred_classes = (y_pred > 0.5).astype(int)\n\n    # Print classification report\n    print("Classification Report:")\n    print(classification_report(y_test, y_pred_classes, target_names=classes))\n\n    # Plot training history\n    plt.figure(figsize=(12, 4))\n\n    plt.subplot(1, 2, 1)\n    plt.plot(history.history[\'loss\'], label=\'Training Loss\')\n    plt.plot(history.history[\'val_loss\'], label=\'Validation Loss\')\n    plt.title(\'Model Loss\')\n    plt.xlabel(\'Epoch\')\n    plt.ylabel(\'Loss\')\n    plt.legend()\n\n    plt.subplot(1, 2, 2)\n    plt.plot(history.history[\'accuracy\'], label=\'Training Accuracy\')\n    plt.plot(history.history[\'val_accuracy\'], label=\'Validation Accuracy\')\n    plt.title(\'Model Accuracy\')\n    plt.xlabel(\'Epoch\')\n    plt.ylabel(\'Accuracy\')\n    plt.legend()\n\n    plt.tight_layout()\n    plt.show()\n    @END\n\n    @END_CODE\n\n    I\'ve implemented all the required components:\n\n    1. Q1.1: Code to read and resize images to 224x224 from the binary folder\n    2. Q1.2: Plot showing the distribution of classes with a bar chart\n    3. Q1.3: Implementation of a feed-forward neural network with:\n      - Input layer (flattened 224x224x3 images)\n      - Two hidden layers (128 and 64 units) with ReLU activation\n      - Dropout layers for regularization\n      - Output layer with sigmoid activation for binary classification\n    4. Q1.4: Classification report and visualization of training history\n\n    Make sure to run the cells in order. The code assumes that your images are in RGB format (3 channels). If they\'re in grayscale, you might need to adjust the input shape accordingly. Let me know if you need any modifications or have questions!\n  </your_response>\n</example>\n</examples>\n\n<important_notes>\n  - Cell IDs must be specified for position-dependent operations. Cell IDs can be found in the notebook, don\'t make up your own (make sure the id matches the one in the notebook exactly)\n  - Operations are executed in sequence\n  - Content between @CREATE/@EDIT and @END maintains original formatting\n  - For code cells, ensure proper indentation is preserved\n  - Focus on brevity and utility in your replies and the changes made.\n  - Remember to ALWAYS have the @END marker at the end of EVERY operation even if @END_CODE is present\n  - DONT add code backticks in code cells like (```python).\n  - Markdown cells should usually be before the cells that they reference\n\n  IMPORTANT: DON\'T perform operations unless the user explicitly requests it\n  IMPORTANT: When inserting cells, make sure to insert them at the correct position (position=bottom will place at the very end of the notebook, not below the last inserted cell)\n  IMPORTANT: You will receive the current cells of the notebook. The cells containing code not deemed important will be condensed.\n  VERY IMPORTANT: DO NOT respond with the condensed code in any of the operations (ie. don\'t have code like model.fit(...) in your response). If you need an expanded version of a cell, request it from the user by asking him to attach the cell required (ex. "Please attach the cell that contains the code for the model implementation by typing @")\n</important_notes>'});for(let e=0;e<vo.length-1;e++)vo[e]&&u.push({role:"user",content:vo[e]}),_o[e]&&u.push({role:"assistant",content:_o[e]});u.push({role:"user",content:`This is the current notebook state for reference: <notebook_state>${i}</notebook_state>. ${e}`}),yield function(e,t){var r,o,i,a;return fo(this,void 0,void 0,function*(){const l=uo(t);if(console.log(`Streaming response for model: ${t}, Provider: ${null==l?void 0:l.provider}`),!l)throw new s({type:n.CONFIGURATION,message:`Unknown model ID: ${t}. Please select a valid model in the settings.`});const c=l.provider,u=yield yo(c),d=ho.createModelFromId(t,u,.7);try{let t="";const n=d.generateStream(e);try{for(var h,p=!0,m=mo(n);h=yield m.next(),!(r=h.done);){a=h.value,p=!1;try{const e=a;if(e.content&&(yield f(e.content,!1),t+=e.content),e.isComplete)break}finally{p=!0}}}catch(e){o={error:e}}finally{try{p||r||!(i=m.return)||(yield i.call(m))}finally{if(o)throw o.error}}yield f("",!0),_o.push(t),console.log("Response:",t)}catch(e){throw console.error(`${c} streaming error:`,e),e}})}(u,o)}catch(e){if(i(),console.error("AI generation error:",e),e.type&&Object.values(n).includes(e.type))return void c(e);if(e instanceof TypeError&&e.message.includes("network"))return void c({type:n.NETWORK,message:"Network connection error",details:e});c({type:n.SERVER,message:e.message||"An unexpected error occurred. Please try again.",details:e})}})}console.log("Background script initialized"),chrome.runtime.onMessage.addListener((e,n,s)=>{console.log("Background received message:",e);const{action:r,type:o}=e;if("ping"===r)return console.log("Received ping"),s({success:!0}),!0;switch(r){case"generateAI":console.log("Generating AI content...");const n=e.model||"gpt-4o-mini";return bo(e.prompt,e.content,n).then(()=>{s({success:!0})}).catch(e=>{console.error("Error generating AI content:",e),s({success:!1,error:e})}),!0;case"restartAI":return console.log("Restarting AI..."),function(){fo(this,void 0,void 0,function*(){go=new t,wo.length=0,vo.length=0,_o.length=0,i()})}(),s({success:!0}),!0;case"OPEN_POPUP":try{const{popupUrl:t,width:n,height:r,left:o,top:i}=e.payload||{};chrome.windows.create({url:t,type:"popup",width:n||350,height:r||500,left:o||100,top:i||100}),s({success:!0})}catch(e){console.error("Error opening popup:",e),s({success:!1,error:e})}return!0;default:return console.log("Unhandled action:",r),s({success:!1,error:`Invalid action: ${r}`}),!0}})})();